<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  
  <title>Heiko - Budget Master V64 (Premium UI)</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    /* --- VARIABLES & THEMES --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --card-bg: #ffffff;
      --text-main: #1e293b; 
      --text-muted: #64748b;
      --border-color: #e2e8f0; /* Bordure tr√®s subtile */
      --input-bg: #f8fafc;
      
      --primary: #2563eb; 
      --accent: #f59e0b;
      /* NOUVEAU VERT PLUS CLASSE (Emerald 600) */
      --success: #059669; 
      --success-light: #d1fae5;
      --success-dark: #064e3b;
      
      --danger: #ef4444;
      --radius: 24px; /* Un peu moins arrondi pour faire moins "jouet" */
      --font-stack: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    /* DARK MODE VARIABLES */
    body.dark-mode {
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --input-bg: #0f172a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-stack); background: var(--bg-gradient); color: var(--text-main); min-height: 100vh; padding: 20px; overflow-x: hidden; transition: background 0.3s ease, color 0.3s ease; }

    /* ANIMATIONS */
    @keyframes moneyFountain { 
        0% { transform: translate(-50%, 0) scale(0.5) rotate(0deg); opacity: 0; } 
        20% { opacity: 1; }
        50% { transform: translate(calc(-50% + var(--rx)), -120px) scale(1) rotate(180deg); } 
        100% { transform: translate(calc(-50% + var(--rx2)), 200px) scale(1) rotate(360deg); opacity: 0; } 
    }

    @keyframes moveStripes { 0% { background-position: 0 0; } 100% { background-position: 50px 0; } }
    
    /* Animation Classy Pulse (Glow sophistiqu√©) */
    @keyframes classyPulse {
        0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); border-color: #059669; }
        50% { box-shadow: 0 10px 30px rgba(5, 150, 105, 0.25); border-color: #34d399; }
        100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); border-color: #059669; }
    }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }

    /* TOAST */
    #toast { visibility: hidden; min-width: 300px; background-color: var(--success); color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 3000; left: 50%; top: 0; font-weight: 700; font-size: 14px; box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; transform:translate(-50%, -100%); transition: all 0.3s; }
    #toast.show { visibility: visible; transform:translate(-50%, 20px); }

    /* --- NOUVEAU SWITCH MODE NUIT (Design Barrette) --- */
    .theme-switch-container {
        position: fixed; bottom: 25px; right: 25px; z-index: 9999;
    }
    .theme-switch {
        width: 54px; height: 28px;
        background-color: #cbd5e1; /* Gris doux jour */
        border-radius: 50px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #94a3b8;
    }
    body.dark-mode .theme-switch { 
        background-color: #334155; /* Gris fonc√© nuit */
        border-color: #475569;
    }
    
    .theme-knob {
        width: 24px; height: 24px;
        background-color: white;
        border-radius: 50%;
        position: absolute;
        top: 1px; left: 1px;
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        display: flex; align-items: center; justify-content: center;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        user-select: none;
    }
    
    /* En mode jour : Le curseur est √† gauche, il montre la lune (cliquer pour nuit) */
    .theme-knob::after { content: 'üåô'; font-size: 12px; line-height: 1; margin-top:1px; margin-left:1px;}
    
    /* En mode nuit : Le curseur va √† droite, il montre le soleil (cliquer pour jour) */
    body.dark-mode .theme-knob {
        transform: translateX(26px);
        background-color: #1e293b;
        color: white;
    }
    body.dark-mode .theme-knob::after { content: '‚òÄÔ∏è'; }

    /* FEEDBACK BUTTON */
    .feedback-btn {
        position: fixed; top: 50%; right: 0; transform: translateY(-50%);
        background: var(--accent); color: white; border: none;
        padding: 12px 18px; border-radius: 30px 0 0 30px;
        box-shadow: -4px 4px 20px rgba(245, 158, 11, 0.2);
        cursor: pointer; z-index: 1000;
        font-weight: 800; font-size: 13px;
        display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    .feedback-btn:hover { padding-right: 25px; background: #d97706; }

    /* ALERTS & MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2500; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
    .modal-box { background: var(--card-bg); padding: 30px; border-radius: var(--radius); width: 100%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 85vh; overflow-y: auto; border: 1px solid var(--border-color); }
    .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display:flex; justify-content:space-between; align-items:center; letter-spacing: -0.5px; }
    textarea.fb-input { width: 100%; height: 120px; padding: 15px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-main); border-radius: 12px; resize: none; font-family: inherit; font-size: 14px; margin-bottom: 20px; outline: none; transition: border 0.2s; }
    textarea.fb-input:focus { border-color: var(--primary); ring: 2px solid rgba(37,99,235,0.1); }

    /* UPDATES STYLE */
    .update-card { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 12px; }
    .update-tag { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    .tag-new { background: #dcfce7; color: #166534; }
    
    /* LOGIN */
    #loginOverlay { position: fixed; inset: 0; background: var(--bg-gradient); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
    .login-box { background: var(--card-bg); padding: 40px; border-radius: var(--radius); box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
    .input-group { position: relative; margin-bottom: 15px; }
    input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border-color); font-size: 14px; background: var(--input-bg); color: var(--text-main); outline: none; transition: 0.2s; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    
    #appContent { display: none; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; position: relative; z-index: 50; flex-wrap: wrap; gap:10px; }
    .user-welcome { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 12px; }
    .user-badge { background: #eff6ff; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-size: 12px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; border: 1px solid #dbeafe; }
    body.dark-mode .user-badge { background: #1e3a8a; border-color:#1e40af; color: #bfdbfe; }

    .container { max-width: 1200px; margin: 0 auto; padding-bottom: 120px; }
    
    header { text-align: center; margin-bottom: 50px; position: relative; z-index: 10; } 
    .header-pill { display: inline-flex; align-items: center; gap: 8px; background: white; border: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.03); padding: 8px 18px; border-radius: 50px; font-size: 11px; font-weight: 900; color: var(--text-muted); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
    body.dark-mode .header-pill { background: #1e293b; color: #94a3b8; }
    h1 { font-size: 42px; font-weight: 900; color: var(--text-main); margin: 0 0 10px; letter-spacing: -1px; text-transform: uppercase; line-height: 1; }
    
    /* SCORE CIRCLE */
    .global-score-container { 
        margin: 40px auto; width: 260px; height: 260px; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; flex-direction: column; 
        position: relative; overflow: visible; 
        background: var(--card-bg);
        border: 4px solid transparent; /* Bordure transparente pour le gradient */
        background: linear-gradient(var(--card-bg), var(--card-bg)) padding-box,
                    linear-gradient(135deg, #f59e0b, #2563eb) border-box; /* Gradient fin */
        box-shadow: 0 20px 50px rgba(37, 99, 235, 0.15);
    }
    
    .score-inner-mask { position: absolute; inset: 4px; border-radius: 50%; overflow: hidden; z-index: 0; background: transparent; }
    .score-fill-level { position: absolute; bottom: 0; left: 0; right: 0; height: 0%; background-color: var(--success-light); transition: height 1.5s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0.4; border-top: 1px solid var(--success); }
    body.dark-mode .score-fill-level { background-color: rgba(6, 78, 59, 0.6); }

    .global-score-value { font-size: 52px; font-weight: 900; color: var(--success); line-height: 1; z-index: 2; position: relative; letter-spacing: -1px; }
    .global-score-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; letter-spacing: 2px; z-index: 2; position: relative; }
    
    .money-rain { position: absolute; inset: 0; pointer-events: none; z-index: 10; width: 100%; height: 100%; overflow: visible; }
    .bill { position: absolute; font-size: 20px; opacity: 0; user-select:none; }

    .objectives-wrapper { display: flex; flex-direction: column; gap: 40px; }
    .category-title { font-size: 20px; font-weight: 800; text-transform: uppercase; color: var(--text-main); margin: 0 0 20px; display: flex; align-items: center; gap: 15px; letter-spacing: 0.5px; }
    .category-title::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }
    
    /* CARDS - DESIGN PRO & CLEAN */
    .card { 
        background: var(--card-bg); border-radius: var(--radius); padding: 30px; 
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02), 0 2px 4px -1px rgba(0,0,0,0.02); 
        position: relative; overflow: hidden; 
        border: 1px solid var(--border-color); /* BORDURE FINE 1PX */
        margin-bottom: 20px; transition: transform 0.2s; 
    }
    .card.is-locked { opacity: 0.7; background: #f9fafb; border-style: dashed; }
    body.dark-mode .card.is-locked { background: #111827; border-color: #374151; }

    /* CARD WINNER - CLASSE */
    .card.is-winner {
        border: 1px solid var(--success); /* Bordure fine verte */
        box-shadow: 0 10px 40px -10px rgba(5, 150, 105, 0.2); /* Ombre diffuse classe */
        animation: classyPulse 4s infinite ease-in-out;
    }

    .status-badge { 
        position: absolute; top: 0; left: 0; right: 0; padding: 10px; 
        text-align: center; font-size: 11px; font-weight: 800; 
        text-transform: uppercase; letter-spacing: 1px; 
    }
    .badge-locked { background: #fff7ed; color: #c2410c; border-bottom: 1px solid #ffedd5; }
    .badge-winner { background: #ecfdf5; color: #047857; border-bottom: 1px solid #d1fae5; }
    .badge-ready { background: #eff6ff; color: var(--primary); border-bottom: 1px solid #dbeafe; }

    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; margin-top: 25px; gap: 15px; }
    .obj-icon { width: 56px; height: 56px; border-radius: 16px; background: #f1f5f9; color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 26px; margin-right: 15px; flex-shrink: 0; border: 1px solid var(--border-color); }
    body.dark-mode .obj-icon { background: #1e293b; }
    
    .data-boxes-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .data-box { flex: 1; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px 15px; display: flex; flex-direction: column; align-items: flex-start; }
    .data-box-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
    .data-box-value { font-size: 18px; font-weight: 800; color: var(--text-main); line-height: 1; }

    .progress-track { height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 30px; position: relative; display: flex; border: 1px solid rgba(0,0,0,0.05); }
    body.dark-mode .progress-track { background: #334155; border:none; }
    .progress-fill { height: 100%; background: var(--primary); transition: width 1s ease; position: relative; }
    .card.is-winner .progress-fill { background: var(--success); }
    .percent-float { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 800; color: white; z-index: 5; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    .milestones { display: flex; justify-content: space-between; position: relative; padding: 0 10px; }
    .milestones::before { content: ''; position: absolute; top: 18px; left: 30px; right: 30px; height: 4px; background: var(--border-color); z-index: 0; border-radius: 4px; }
    .ms-item { z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; width: 30%; position: relative; }
    .ms-circle { width: 40px; height: 40px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #94a3b8; transition: 0.3s; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .ms-item.unlocked .ms-circle { border-color: var(--success); background: #ecfdf5; color: var(--success); transform: scale(1.1); font-size: 18px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2); }
    .ms-prize { font-size: 12px; background: var(--input-bg); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border-color); font-weight: 700; color: var(--text-muted); }
    .ms-item.unlocked .ms-prize { background: var(--success); color: white; border-color: var(--success); }

    .fixed-bonus-block { background: var(--input-bg); border: 1px dashed var(--border-color); border-radius: 12px; padding: 15px; text-align: center; color: var(--text-muted); font-weight: 700; }
    .fixed-bonus-block.unlocked { background: #ecfdf5; border: 1px solid var(--success); color: var(--success-dark); }
    .earned-badge-container { margin-top: 25px; display: flex; justify-content: center; }
    .earned-badge { background: #ecfdf5; color: var(--success-dark); padding: 10px 20px; border-radius: 50px; font-weight: 800; font-size: 15px; border: 1px solid #6ee7b7; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.15); }

    /* CALENDAR */
    .native-cal-container { margin-top: 60px; background: var(--card-bg); border-radius: var(--radius); padding: 25px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cal-month-title { font-size: 15px; font-weight: 800; text-transform: uppercase; color: var(--text-main); letter-spacing: 0.5px; }
    .cal-nav-btn { background: var(--input-bg); border: 1px solid var(--border-color); width: 32px; height: 32px; border-radius: 8px; color: var(--text-main); font-weight: 700; cursor: pointer; transition:0.2s; }
    .cal-nav-btn:hover { border-color: var(--primary); color: var(--primary); }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .cal-day-name { text-align: center; font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; padding-bottom: 8px; }
    .cal-cell { background: var(--input-bg); border-radius: 8px; min-height: 55px; padding: 5px; border: 1px solid transparent; transition:0.2s; }
    .cal-cell:hover { border-color: var(--border-color); background: var(--card-bg); }
    .cal-date { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; display: block; }
    .cal-event-dot { display: block; font-size: 9px; padding: 3px 6px; border-radius: 4px; margin-bottom: 2px; color: white; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .evt-sturia { background-color: #f59e0b; }
    .evt-heiko { background-color: #3b82f6; }
    .evt-deliv { background-color: #ef4444; }
    .evt-uber { background-color: #10b981; }
    .evt-street { background-color: #8b5cf6; }

    /* ADMIN PANEL */
    .admin-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 550px; background: var(--bg-gradient); z-index: 2000; box-shadow: -10px 0 40px rgba(0,0,0,0.1); padding: 25px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; border-left: 1px solid var(--border-color); }
    .admin-panel.active { transform: translateX(0); }
    .close-admin { position: absolute; top: 25px; right: 25px; font-size: 24px; background: none; border: none; cursor: pointer; color: var(--text-muted); }
    .admin-section { background: var(--card-bg); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; text-transform: uppercase; background: var(--primary); color: white; font-size: 13px; letter-spacing: 0.5px; transition: 0.2s; box-shadow: 0 4px 12px rgba(37,99,235,0.25); }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(37,99,235,0.3); }
    .btn-tab { flex:1; padding: 12px; font-size: 12px; font-weight: 700; color: var(--text-muted); background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .btn-tab.active { background: var(--text-main); color: var(--card-bg); border-color: var(--text-main); }
    
    .tab-nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    
    .user-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--input-bg); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border-color); }
    .user-name { font-weight: 700; font-size: 13px; color: var(--text-main); }
    
    /* COCKPIT & SLIDERS */
    .cockpit-container { padding: 20px; border: 1px solid #bfdbfe; border-radius: 16px; background: #eff6ff; margin-bottom: 20px; }
    body.dark-mode .cockpit-container { background: #172554; border-color: #1e3a8a; }
    
    input[type=range] { width: 100%; -webkit-appearance: none; appearance: none; height: 6px; background: #e2e8f0; border-radius: 10px; cursor: pointer; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--primary); border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.2); margin-top: -9px; }

    #simGlobalBudget { text-align: center; font-size: 14px; font-weight: 800; color: var(--primary); border: 1px solid #bfdbfe; padding: 6px; width: 100px; border-radius: 8px; background: white; }

    @media (max-width: 600px) { .container { padding: 15px; } .card { padding: 20px; } .global-score-value { font-size: 42px; } }
  </style>
</head>
<body>

  <div class="theme-switch-container">
      <div class="theme-switch" onclick="toggleDarkMode()">
          <div class="theme-knob"></div> </div>
  </div>

  <div id="topAlert">
      <div class="alert-icon">üì£</div>
      <div class="alert-content">
          <div class="alert-title">NOUVEAUT√â !</div>
          <div class="alert-desc" id="topAlertText">...</div>
      </div>
  </div>

  <div class="feedback-btn" onclick="document.getElementById('feedbackModal').style.display='flex'">üí° Une id√©e ?</div>

  <div id="feedbackModal" class="modal-overlay">
      <div class="modal-box">
          <div class="modal-title">
              <span>üí° Bo√Æte √† id√©es</span>
              <button style="border:none; background:none; cursor:pointer; font-size:20px; color:var(--text-muted);" onclick="document.getElementById('feedbackModal').style.display='none'">√ó</button>
          </div>
          <p style="font-size:13px; color:var(--text-muted); margin-bottom:15px;">Une suggestion pour am√©liorer l'outil ou l'√©quipe ? Dites-le nous !</p>
          <textarea id="fbContent" class="fb-input" placeholder="Votre message..."></textarea>
          <div style="display:flex; gap:10px;">
              <button class="btn" onclick="sendFeedback()">Envoyer</button>
          </div>
      </div>
  </div>

  <div id="updatesModal" class="modal-overlay">
      <div class="modal-box">
          <div class="modal-title">
             <span>üì¢ Derni√®res Nouveaut√©s</span>
             <button style="border:none; background:none; font-size:20px; cursor:pointer; color:var(--text-main);" onclick="document.getElementById('updatesModal').style.display='none'">√ó</button>
          </div>
          <div id="publicUpdatesList" style="display:flex; flex-direction:column; gap:10px;">
              <div style="text-align:center; color:#999;">Chargement...</div>
          </div>
      </div>
  </div>

  <div id="toast">‚úÖ Action effectu√©e avec succ√®s !</div>

  <div id="loginOverlay">
    <h1 style="font-size: 24px; font-weight: 900; color: var(--text-main); margin-bottom: 25px; text-transform: uppercase; text-align: center; line-height: 1.4;">üöÄ DASHBOARD SUIVI üöÄ<br>LAFAYETTE</h1>
    
    <div class="login-box">
      <h2 style="font-size:16px; font-weight:800; margin-bottom:20px; color:var(--text-muted);">CONNEXION MEMBRE</h2>
      <div class="input-group">
          <input type="email" id="loginEmail" placeholder="Email" oninput="clearLoginError()">
      </div>
      <div class="input-group">
          <input type="password" id="loginPass" placeholder="Mot de passe" oninput="clearLoginError()">
      </div>
      <button class="btn" id="btnLogin">Connexion</button>
      <a onclick="resetPassword()" style="display:block; margin-top:20px; font-size:12px; color:var(--text-muted); text-decoration:underline; cursor:pointer;">Mot de passe oubli√© ?</a>
    </div>
  </div>

  <div id="appContent">
    <div class="top-bar">
      <div class="user-welcome">
        <span id="userName">--</span> 
        <span class="user-badge" id="userHours">--h</span>
        <button onclick="document.getElementById('updatesModal').style.display='flex'" style="border:none; background:#ecfdf5; color:#059669; border-radius:20px; padding:5px 12px; font-size:11px; font-weight:800; cursor:pointer; margin-left:5px; border:1px solid #d1fae5;">üì¢ Nouveaut√©s</button>
      </div>
      <div style="display:flex; gap:10px;">
        <button id="btnAdmin" class="btn" style="width:auto; padding:8px 16px; font-size:11px; display:none;">‚öôÔ∏è Admin</button>
        <button onclick="logout()" class="btn" style="width:auto; padding:8px 16px; font-size:11px; background:white; color:#ef4444; border:1px solid #fca5a5; box-shadow:none;">D√©connexion</button>
      </div>
    </div>

    <div class="container">
      <header>
        <div class="header-pill">üöÄ Dashboard Live</div>
        <h1>OBJECTIFS HEIKO</h1>
        <div style="font-size:13px; color:var(--text-muted); font-weight:600;" id="lastUpdate">Chargement...</div>
        
        <div class="global-score-container" id="scoreCircle">
          <div class="score-inner-mask">
              <div class="score-fill-level" id="moneyFill"></div>
          </div>
          <div class="money-rain" id="moneyRain"></div>
          
          <div class="global-score-value" id="myTotalGain">0‚Ç¨</div>
          <div class="global-score-label">MES PRIMES<br>D√âBLOQU√âES</div>
        </div>
      </header>
      
      <div class="objectives-wrapper" id="cardsContainer">
        <div style="text-align:center; color:#9ca3af; margin-top:50px;">Chargement des donn√©es...</div>
      </div>

      <div class="category-title" style="margin-top:60px; justify-content:center;">Planning üìÖ</div>

      <div class="native-cal-container">
          <div class="cal-header">
             <button class="cal-nav-btn" onclick="prevMonth()">‚ùÆ</button>
             <div class="cal-month-title" id="calTitle">D√âCEMBRE 2025</div>
             <button class="cal-nav-btn" onclick="nextMonth()">‚ùØ</button>
          </div>
          <div class="cal-grid" style="margin-bottom:10px;">
             <div class="cal-day-name">LUN</div><div class="cal-day-name">MAR</div><div class="cal-day-name">MER</div><div class="cal-day-name">JEU</div><div class="cal-day-name">VEN</div><div class="cal-day-name">SAM</div><div class="cal-day-name">DIM</div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
      </div>
    </div>
  </div>

  <div class="admin-panel" id="adminPanel">
    <button class="close-admin" onclick="toggleAdmin(false)">√ó</button>
    <h2 style="margin-bottom:20px; font-weight:800; font-size:22px;">Panneau Manager</h2>
    
    <div class="tab-nav">
      <button id="btnTabTeam" onclick="switchTab('team')" class="btn-tab active">üë• √âquipe</button>
      <button id="btnTabObjs" onclick="switchTab('objs')" class="btn-tab">üéØ Pilotage</button>
      <button id="btnTabLogs" onclick="switchTab('logs')" class="btn-tab" style="display:none;">üïí Historique</button>
      <button id="btnTabFeedbacks" onclick="switchTab('feedbacks')" class="btn-tab" style="display:none;">üí¨ Avis</button>
    </div>

    <div id="tab-team">
      <div class="admin-section">
        <h3 style="font-size:14px; font-weight:800; margin-bottom:15px; text-transform:uppercase; color:var(--text-muted);">Ajouter un Membre</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <input type="text" id="nuName" placeholder="Pr√©nom">
          <input type="number" id="nuHours" placeholder="Heures">
        </div>
        <input type="email" id="nuEmail" placeholder="Email" style="margin-top:10px;">
        <div style="margin:10px 0;"><input type="checkbox" id="nuAdmin" style="width:auto; vertical-align:middle;"> <label style="font-size:12px;">Admin ?</label></div>
        <button class="btn" onclick="createUser()">Inviter le membre</button>
      </div>
      <div class="admin-section">
        <h3 style="font-size:14px; font-weight:800; margin-bottom:15px; text-transform:uppercase; color:var(--text-muted);">Effectif & Primes</h3>
        <div id="usersList"></div>
      </div>
    </div>

    <div id="tab-objs" style="display:none;">
      <div class="admin-section" id="superAdminBudget" style="display:none;">
         <h3 style="font-size:14px; font-weight:800; margin-bottom:15px; text-transform:uppercase; color:var(--primary);">üéõÔ∏è Pilotage Budget</h3>
         <div class="cockpit-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <label style="font-size:11px; font-weight:700; color:#64748b;">BUDGET GLOBAL (‚Ç¨)</label>
                <div style="display:flex; align-items:center;">
                   <input type="number" id="simGlobalBudget" oninput="updateSim()">
                   <button id="btnSaveGlobalBudget" onclick="saveGlobalBudget()" style="border:none; background:var(--primary); color:white; padding:6px 10px; border-radius:6px; font-size:11px; margin-left:5px; cursor:pointer;">OK</button>
                </div>
            </div>
            <div style="height:8px; background:#bfdbfe; border-radius:10px; overflow:hidden; margin-bottom:5px;">
                <div style="height:100%; width:0; background:var(--primary); transition:width 0.3s;" id="simGauge"></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700; color:#64748b;">
                <span id="simUsed">0‚Ç¨ Engag√©s</span>
                <span id="simLeft">Reste : 0‚Ç¨</span>
            </div>
            <div id="simObjList" style="margin-top:20px;"></div>
         </div>
         <button class="btn" onclick="publishSim()" style="background:var(--success);">üì° PUBLIER</button>
      </div>

      <div class="admin-section">
        <h3 style="font-size:14px; font-weight:800; margin-bottom:15px; text-transform:uppercase; color:var(--text-muted);">‚ûï Nouvel Objectif</h3>
        <input type="text" id="noName" placeholder="Nom">
        <input type="text" id="noTarget" placeholder="Cible" style="margin-top:10px;">
        <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;">
            <label style="font-size:12px;"><input type="checkbox" id="noPrimary" checked> Principal</label>
            <label style="font-size:12px;"><input type="checkbox" id="noInverse"> Invers√©</label>
            <label style="font-size:12px;"><input type="checkbox" id="noNumeric"> Nombre</label>
            <label style="font-size:12px;"><input type="checkbox" id="noFixed" onchange="toggleCreateInputs()"> Fixe</label>
        </div>
        <div id="createTiersBlock" style="margin-top:10px;">
             <label style="font-size:11px; font-weight:700;">Seuils (%)</label>
             <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                 <input type="number" id="c_p1t" placeholder="P1">
                 <input type="number" id="c_p2t" placeholder="P2">
                 <input type="number" id="c_p3t" placeholder="P3">
             </div>
        </div>
        <button class="btn" onclick="addObj()" style="margin-top:15px;">Ajouter</button>
      </div>

      <div class="admin-section">
        <h3 style="font-size:14px; font-weight:800; margin-bottom:15px; text-transform:uppercase; color:var(--text-muted);">üìù Modifier / Supprimer</h3>
        <div id="objList"></div>
      </div>
    </div>
    
    <div id="tab-logs" style="display:none;"><div class="admin-section" id="logsContainer"></div></div>
    <div id="tab-feedbacks" style="display:none;">
        <div class="admin-section">
             <h3 style="font-size:14px; margin-bottom:10px;">üì¢ Annonces</h3>
             <input type="hidden" id="uptId"> <input type="text" id="uptTitle" placeholder="Titre">
             <textarea id="uptDesc" class="fb-input" style="height:60px; margin-top:5px;" placeholder="Message..."></textarea>
             <select id="uptType" style="margin-bottom:10px;"><option value="new">Nouveaut√©</option><option value="impr">Am√©lioration</option><option value="fix">Correction</option></select>
             <div style="display:flex; gap:5px;">
                 <button class="btn" id="btnSaveUpdate" onclick="saveUpdate()">Publier</button>
                 <button class="btn" id="btnCancelUpdate" onclick="cancelUpdateEdit()" style="background:#e2e8f0; color:#475569; display:none;">Annuler</button>
             </div>
             <div id="adminUpdatesList" style="margin-top:20px;"></div>
        </div>
        <div class="admin-section" id="feedbacksContainer"></div>
    </div>
  </div>

  <div class="admin-panel" id="editUserPanel" style="z-index:2100; max-width:400px; border-left:4px solid #0ea5e9;">
    <h3 style="margin-bottom:15px; color:#0ea5e9;">Modifier Membre</h3>
    <input type="hidden" id="euId">
    <input type="text" id="euName" placeholder="Nom">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
      <input type="number" id="euHours" placeholder="H">
      <input type="text" id="euEmail" disabled style="opacity:0.6">
    </div>
    <div style="margin:15px 0;"><input type="checkbox" id="euAdmin"> Admin</div>
    <button class="btn" onclick="saveUser()">Enregistrer</button>
    <button class="btn" onclick="document.getElementById('editUserPanel').classList.remove('active')" style="background:white; color:#666; border:1px solid #ccc; margin-top:10px; box-shadow:none;">Annuler</button>
  </div>

  <div class="admin-panel" id="editObjPanel" style="z-index:2100; max-width:400px; border-left:4px solid var(--primary);">
    <h3 style="margin-bottom:15px; color:var(--primary);">Modifier Objectif</h3>
    <input type="hidden" id="eoId">
    <input type="text" id="eoName" placeholder="Nom">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
      <input type="text" id="eoCurrent" placeholder="Actuel">
      <input type="text" id="eoTarget" placeholder="Cible">
    </div>
    <div style="margin:10px 0; display:flex; flex-wrap:wrap; gap:10px;">
        <label style="font-size:12px;"><input type="checkbox" id="eoPrimary"> Principal</label>
        <label style="font-size:12px;"><input type="checkbox" id="eoInverse"> Invers√©</label>
        <label style="font-size:12px;"><input type="checkbox" id="eoNumeric"> Nombre</label>
        <label style="font-size:12px;"><input type="checkbox" id="eoFixed" onchange="toggleEditInputs()"> Fixe</label>
    </div>
    <div id="editTiersBlock">
        <label style="font-size:11px; font-weight:700;">Seuils (%)</label>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
            <input type="number" id="p1t">
            <input type="number" id="p2t">
            <input type="number" id="p3t">
        </div>
    </div>
    <input type="hidden" id="p1p"><input type="hidden" id="p2p"><input type="hidden" id="p3p"><input type="hidden" id="eoFixedPrize">
    <div style="margin-top:10px;"><input type="checkbox" id="eoHideTarget"> Masquer Cible <input type="checkbox" id="eoHideCurrent" style="margin-left:10px;"> Masquer Valeur</div>
    <button class="btn" onclick="saveObj()" style="margin-top:15px;">Enregistrer</button>
    <button class="btn" onclick="document.getElementById('editObjPanel').classList.remove('active')" style="background:white; color:#666; border:1px solid #ccc; margin-top:10px; box-shadow:none;">Annuler</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAGaitqmFwExvJ9ZUpkdUdCKAqqDOP2cdQ",
      authDomain: "objectif-restaurant.firebaseapp.com",
      databaseURL: "https://objectif-restaurant-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "objectif-restaurant",
      storageBucket: "objectif-restaurant.firebasestorage.app",
      messagingSenderId: "910113283000",
      appId: "1:910113283000:web:0951fd9dca01aa6e46cd4d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let allUsers = {}, allObjs = {}, allLogs = {}, allFeedbacks = {}, allUpdates = {};
    let globalSettings = { budget: 0 };
    const BASE_HOURS = 35;
    const SUPER_ADMIN_EMAIL = "teddy.frey1@gmail.com";
    
    // THEME MANAGEMENT
    function initTheme() {
        const isDark = localStorage.getItem('heiko_dark_mode') === 'true';
        if(isDark) document.body.classList.add('dark-mode');
    }
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('heiko_dark_mode', document.body.classList.contains('dark-mode'));
    }
    initTheme();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("appContent").style.display = "block";
        db.ref('users/' + user.uid).on('value', snap => {
          const val = snap.val();
          if(!val) {
             const def = { name: "Utilisateur", hours:35, role:'staff', email: user.email, status: 'pending' };
             db.ref('users/'+user.uid).set(def); currentUser = def;
          } else { 
             currentUser = val; 
             if(currentUser.status !== 'active') db.ref('users/'+user.uid).update({ status: 'active', lastLogin: Date.now() });
          }
          currentUser.uid = user.uid; currentUser.email = user.email;
          updateUI();
        });
        loadData();
        renderNativeCalendar();
      } else {
        document.getElementById("loginOverlay").style.display = "flex";
        document.getElementById("appContent").style.display = "none";
      }
    });

    document.getElementById("btnLogin").onclick = () => {
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPass").value;
      auth.signInWithEmailAndPassword(email, pass).catch(e => alert("‚ùå Erreur: " + e.message));
    };

    function logout() { auth.signOut(); location.reload(); }
    window.resetPassword = () => {
      let email = document.getElementById("loginEmail").value.trim();
      if (!email) email = prompt("Email :");
      if(email) auth.sendPasswordResetEmail(email).then(() => alert("Email envoy√© !")).catch(e => alert(e.message));
    };

    function showToast(message) {
        const toast = document.getElementById("toast"); toast.textContent = message; toast.className = "show";
        setTimeout(() => { toast.className = "hide"; }, 3000);
    }

    function loadData() {
      db.ref('objectives').on('value', s => { 
          allObjs = s.val() || {}; 
          renderDashboard(); 
          if(currentUser && (currentUser.role === 'admin' || currentUser.email === SUPER_ADMIN_EMAIL)) { renderAdminObjs(); renderSimulator(); }
      });
      db.ref('users').on('value', s => { allUsers = s.val() || {}; if(currentUser && (currentUser.role==='admin' || currentUser.email === SUPER_ADMIN_EMAIL)) { renderAdminUsers(); renderSimulator(); } });
      db.ref('settings').on('value', s => { globalSettings = s.val() || { budget: 0 }; if(currentUser && (currentUser.role==='admin' || currentUser.email === SUPER_ADMIN_EMAIL)) { renderSimulator(); } });
      db.ref('logs').limitToLast(100).on('value', s => { allLogs = s.val() || {}; if(currentUser && currentUser.email === SUPER_ADMIN_EMAIL) renderLogs(allLogs); });
      db.ref('feedbacks').on('value', s => { allFeedbacks = s.val() || {}; if(currentUser && currentUser.email === SUPER_ADMIN_EMAIL) renderFeedbacks(allFeedbacks); });
      db.ref('updates').on('value', s => { 
          allUpdates = s.val() || {}; renderUpdatesPublic(); checkNewUpdates(allUpdates);
          if(currentUser && currentUser.email === SUPER_ADMIN_EMAIL) renderUpdatesAdmin();
      });
    }

    function checkNewUpdates(updates) {
        const arr = Object.values(updates).sort((a,b) => b.date - a.date);
        if(arr.length === 0) return;
        const latest = arr[0];
        const latestId = latest.title + "_" + latest.date;
        if(localStorage.getItem('heiko_last_update_seen') !== latestId) {
            document.getElementById("topAlertText").textContent = latest.title;
            const al = document.getElementById("topAlert"); al.classList.remove("trigger"); void al.offsetWidth; al.classList.add("trigger");
            localStorage.setItem('heiko_last_update_seen', latestId);
        }
    }

    function updateUI() {
      if(!currentUser) return;
      document.getElementById("userName").textContent = currentUser.name;
      document.getElementById("userHours").textContent = (currentUser.hours || 35) + "h";
      const isSuperUser = (currentUser.email && currentUser.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase());
      const isAdmin = (currentUser.role === 'admin' || isSuperUser);
      document.getElementById("btnAdmin").style.display = isAdmin ? 'block' : 'none';
      document.getElementById("btnTabLogs").style.display = isSuperUser ? 'block' : 'none';
      document.getElementById("btnTabFeedbacks").style.display = isSuperUser ? 'block' : 'none';
      if(isSuperUser) { document.getElementById("superAdminBudget").style.display = "block"; }
    }

    function renderDashboard() {
      if(!currentUser) return;
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";
      const ratio = (currentUser.hours || 35) / BASE_HOURS;
      let totalMyGain = 0; let totalPotentialGain = 0;
      
      const prims = Object.values(allObjs).filter(o => o.isPrimary && o.published);
      let primOk = true;
      if(prims.length > 0) {
        primOk = prims.every(o => {
           if(o.isFixed) return o.isNumeric ? parseFloat(o.current)>=o.target : getPct(o.current,o.target,o.isInverse)>=100;
           if(o.paliers && o.paliers[0]) return o.isNumeric ? parseFloat(o.current)>=o.paliers[0].threshold : getPct(o.current,o.target,o.isInverse)>=o.paliers[0].threshold;
           return false;
        });
      }

      if(prims.length > 0) container.innerHTML += `<div class="category-title">üî•&nbsp;<span>Priorit√© Absolue</span></div>`;
      prims.forEach(o => { totalPotentialGain += getMaxPossibleGain(o)*ratio; container.appendChild(createCard(o, false, ratio, true)); });

      const secs = Object.values(allObjs).filter(o => !o.isPrimary && o.published);
      if(secs.length > 0) container.innerHTML += `<div class="category-title" style="color:var(--text-muted); font-size:16px; margin-top:40px;">üíé&nbsp;<span>Bonus D√©blocables</span></div>`;
      secs.forEach(o => { totalPotentialGain += getMaxPossibleGain(o)*ratio; container.appendChild(createCard(o, !primOk, ratio, false)); });

      Object.keys(allObjs).forEach(key => {
        const o = allObjs[key]; if(!o.published) return;
        const pct = getPct(o.current, o.target, o.isInverse);
        const isLocked = !o.isPrimary && !primOk;
        if(!isLocked) {
             if(o.isFixed) {
                 let win = o.isNumeric ? parseFloat(o.current)>=o.target : pct>=100;
                 if(win && o.paliers && o.paliers[0]) totalMyGain += (parse(o.paliers[0].prize) * ratio);
             } else {
                 if(o.paliers) o.paliers.forEach(p => { 
                     let unlocked = o.isNumeric ? parseFloat(o.current)>=p.threshold : pct>=p.threshold;
                     if(unlocked) totalMyGain += (parse(p.prize) * ratio); 
                 });
             }
        }
      });

      document.getElementById("myTotalGain").textContent = totalMyGain.toFixed(2) + "‚Ç¨";
      let fillPercent = totalPotentialGain > 0 ? (totalMyGain / totalPotentialGain) * 100 : 0;
      if(fillPercent>100) fillPercent=100;
      document.getElementById("moneyFill").style.height = fillPercent + "%";
      document.getElementById("lastUpdate").textContent = "M√†J: " + new Date().toLocaleDateString('fr-FR');
      
      const rain = document.getElementById("moneyRain"); rain.innerHTML = "";
      if(totalMyGain > 0) {
         for(let i=0; i<20; i++) {
            const b = document.createElement("div"); b.className="bill"; b.textContent="üí∏";
            b.style.setProperty('--rx', (Math.random()-0.5)*100+"px"); b.style.setProperty('--rx2', (Math.random()-0.5)*200+"px");
            b.style.left="50%"; b.style.bottom="-50px"; b.style.animation=`moneyFountain ${2+Math.random()}s infinite ${Math.random()}s ease-in-out`;
            rain.appendChild(b);
         }
      }
    }

    function createCard(obj, isLocked, userRatio, isPrimary) {
      const pct = getPct(obj.current, obj.target, obj.isInverse);
      let isWin = false;
      if(obj.isFixed) isWin = obj.isNumeric ? parseFloat(obj.current)>=obj.target : pct>=100;
      else if(obj.paliers && obj.paliers[0]) isWin = obj.isNumeric ? parseFloat(obj.current)>=obj.paliers[0].threshold : pct>=obj.paliers[0].threshold;

      const el = document.createElement("div");
      let cls = "card"; if(isLocked) cls += " is-locked"; if(isWin && !isLocked) cls += " is-winner";
      el.className = cls;

      let badge = "";
      if(isLocked) badge = `<div class="status-badge badge-locked">üîí D√âBLOQUER D'ABORD</div>`;
      else if(isWin) badge = `<div class="status-badge badge-winner">üéâ OBJECTIF VALID√â</div>`;
      else if(!isPrimary) badge = `<div class="status-badge badge-ready">BONUS ACTIF</div>`;

      let earnedBadge = "";
      let myGain = 0;
      if(!isLocked) {
        if(obj.isFixed && isWin && obj.paliers[0]) myGain = parse(obj.paliers[0].prize);
        else if(!obj.isFixed && obj.paliers) {
            obj.paliers.forEach(p => { 
                if(obj.isNumeric ? parseFloat(obj.current)>=p.threshold : pct>=p.threshold) myGain += parse(p.prize);
            });
        }
      }
      if(!isLocked && myGain > 0) earnedBadge = `<div class="earned-badge-container"><div class="earned-badge">üí∂ Prime : ${(myGain*userRatio).toFixed(2)}‚Ç¨</div></div>`;

      let middleHtml = "";
      if(obj.isFixed) {
          const prizeAmount = (obj.paliers && obj.paliers[0]) ? parse(obj.paliers[0].prize) : 0;
          middleHtml = `<div class="fixed-bonus-block ${isWin && !isLocked ? 'unlocked' : ''}"><div style="font-size:10px; text-transform:uppercase; margin-bottom:5px;">PRIME UNIQUE</div><div style="font-size:24px; font-weight:900;">${(prizeAmount * userRatio).toFixed(2)}‚Ç¨</div></div>`;
      } else {
          middleHtml = `<div class="milestones">`;
          (obj.paliers||[]).forEach((p, i) => {
               let u = obj.isNumeric ? parseFloat(obj.current)>=p.threshold : pct>=p.threshold;
               middleHtml += `<div class="ms-item ${u?'unlocked':''}"><div style="position:absolute; top:-25px; font-size:10px; font-weight:700; color:#94a3b8;">${p.threshold}${obj.isNumeric?'':'%'}</div><div class="ms-circle">${u?'‚úì':(i+1)}</div><div class="ms-prize">+${(parse(p.prize)*userRatio).toFixed(2)}‚Ç¨</div></div>`;
          });
          middleHtml += `</div>`;
      }

      let targetVal = obj.hideTarget ? 'üîí' : obj.target + (obj.isInverse && !obj.isNumeric ? '%' : '');
      let currentVal = obj.hideCurrent ? 'üîí' : obj.current + (obj.isInverse && !obj.isNumeric ? '%' : '');
      if(obj.isNumeric) { targetVal=obj.target; currentVal=obj.current; }

      el.innerHTML = `
        ${badge}
        <div class="card-top">
          <div style="display:flex; align-items:center;">
             <div class="obj-icon">${isPrimary?'‚ö°':'üíé'}</div>
             <div>
               <h3 style="font-weight:800; font-size:18px; margin-bottom:2px;">${obj.name}</h3>
               <div style="font-size:11px; color:var(--text-muted); font-weight:700;">${isPrimary ? 'PRIORIT√â ABSOLUE' : 'BONUS ADDITIONNEL'}</div>
             </div>
          </div>
        </div>
        <div class="data-boxes-row"><div class="data-box"><span class="data-box-label">R√âALIS√â</span><span class="data-box-value">${currentVal}</span></div><div class="data-box"><span class="data-box-label">CIBLE</span><span class="data-box-value">${targetVal}</span></div></div>
        <div class="progress-track"><div class="percent-float">${obj.isNumeric ? Math.floor(obj.current)+'/'+obj.target : pct.toFixed(1)+'%'}</div><div class="progress-fill" style="width:${Math.min(pct,100)}%"></div></div>
        ${middleHtml}${earnedBadge}`;
      return el;
    }
    
    // --- HELPER FUNCTIONS ---
    function toggleAdmin(show) { document.getElementById("adminPanel").classList.toggle("active", show); }
    function switchTab(t) {
       document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
       document.getElementById('btnTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
       ['team','objs','logs','feedbacks'].forEach(x => document.getElementById('tab-'+x).style.display = (x===t)?'block':'none');
    }
    function getMaxPossibleGain(obj) { if(!obj) return 0; if(obj.isFixed) return (obj.paliers&&obj.paliers[0])?parse(obj.paliers[0].prize):0; let s=0; if(obj.paliers) obj.paliers.forEach(p=>s+=parse(p.prize)); return s; }
    function getPct(c, t, inv) { let cv=parseFloat(String(c).replace(',','.')), tv=parseFloat(String(t).replace(',','.')); if(isNaN(cv)||isNaN(tv))return 0; if(inv) return (cv<=tv)?100:0; return (!tv)?0:(cv/tv)*100; }
    function parse(s) { return parseFloat(String(s).replace(/[^0-9.]/g,''))||0; }
    function toggleCreateInputs() { document.getElementById("createTiersBlock").style.display = document.getElementById("noFixed").checked ? 'none':'block'; }
    function toggleEditInputs() { document.getElementById("editTiersBlock").style.display = document.getElementById("eoFixed").checked ? 'none':'block'; }

    // --- ADMIN LOGIC ---
    function renderAdminUsers() {
        const d = document.getElementById("usersList"); d.innerHTML="";
        Object.entries(allUsers).forEach(([k, u]) => {
           const div = document.createElement("div"); div.className="user-item";
           div.innerHTML=`<div><div class="user-name">${u.name}</div><div style="font-size:11px; color:#64748b;">${u.hours||0}h ‚Ä¢ ${u.email}</div></div>
           <div><button class="btn" onclick="openEditUser('${k}')" style="width:auto; padding:5px 10px; font-size:10px;">Modifier</button><button onclick="deleteUser('${k}')" style="border:none; background:none; color:#ef4444; margin-left:5px; cursor:pointer;">√ó</button></div>`;
           d.appendChild(div);
        });
    }
    function createUser() {
        const n=document.getElementById("nuName").value, h=document.getElementById("nuHours").value, e=document.getElementById("nuEmail").value, adm=document.getElementById("nuAdmin").checked;
        if(n && h && e) {
             auth.createUserWithEmailAndPassword(e, "heiko123").then(c => {
                 db.ref('users/'+c.user.uid).set({ name:n, hours:parseFloat(h), email:e, role:adm?'admin':'staff', status:'active' });
                 auth.signInWithEmailAndPassword(currentUser.email, prompt("Reconnectez-vous (S√©curit√©):"));
                 alert("Utilisateur cr√©√© !");
             }).catch(e=>alert(e.message));
        }
    }
    function openEditUser(id) {
        const u = allUsers[id]; if(!u) return;
        document.getElementById("euId").value=id; document.getElementById("euName").value=u.name; document.getElementById("euHours").value=u.hours; document.getElementById("euEmail").value=u.email; document.getElementById("euAdmin").checked=(u.role==='admin');
        document.getElementById("editUserPanel").classList.add("active");
    }
    function saveUser() {
        const id=document.getElementById("euId").value;
        db.ref('users/'+id).update({ name:document.getElementById("euName").value, hours:parseFloat(document.getElementById("euHours").value), role:document.getElementById("euAdmin").checked?'admin':'staff' });
        document.getElementById("editUserPanel").classList.remove("active");
    }
    function deleteUser(id) { if(confirm("Supprimer ?")) db.ref('users/'+id).remove(); }

    function renderAdminObjs() {
        const l = document.getElementById("objList"); l.innerHTML="";
        Object.entries(allObjs).forEach(([k, o]) => {
           const d=document.createElement("div"); d.className="user-item";
           d.innerHTML=`<div><div class="user-name">${o.name}</div><div style="font-size:11px; color:#64748b;">${o.current} / ${o.target}</div></div>
           <div><button class="btn" onclick="openEditObj('${k}')" style="width:auto; padding:5px 10px; font-size:10px;">Edit</button><button onclick="if(confirm('Supprimer?')) db.ref('objectives/'+'${k}').remove()" style="border:none; background:none; color:#ef4444; margin-left:5px; cursor:pointer;">√ó</button></div>`;
           l.appendChild(d);
        });
    }
    function addObj() {
        const n=document.getElementById("noName").value, t=document.getElementById("noTarget").value;
        if(!n || !t) return;
        const isFixed=document.getElementById("noFixed").checked;
        const newObj = { name:n, target:t, current:"0", isPrimary:document.getElementById("noPrimary").checked, isInverse:document.getElementById("noInverse").checked, isNumeric:document.getElementById("noNumeric").checked, isFixed:isFixed, published:false, paliers:[] };
        if(!isFixed) {
            [1,2,3].forEach(i => { const v=document.getElementById("c_p1t").value; if(v) newObj.paliers.push({ threshold:parseFloat(v), prize:0 }); }); 
        } else { newObj.paliers.push({ threshold:100, prize:0 }); }
        db.ref('objectives').push(newObj);
        document.getElementById("noName").value="";
    }
    function openEditObj(id) {
        const o=allObjs[id]; if(!o) return;
        document.getElementById("eoId").value=id; document.getElementById("eoName").value=o.name; document.getElementById("eoCurrent").value=o.current; document.getElementById("eoTarget").value=o.target;
        document.getElementById("eoPrimary").checked=o.isPrimary; document.getElementById("eoInverse").checked=o.isInverse; document.getElementById("eoNumeric").checked=o.isNumeric; document.getElementById("eoFixed").checked=o.isFixed;
        document.getElementById("eoHideTarget").checked=o.hideTarget||false; document.getElementById("eoHideCurrent").checked=o.hideCurrent||false;
        if(o.paliers) {
            o.paliers.forEach((p, i) => { if(i<3) { document.getElementById("p"+(i+1)+"t").value=p.threshold; document.getElementById("p"+(i+1)+"p").value=p.prize; } });
        }
        toggleEditInputs(); document.getElementById("editObjPanel").classList.add("active");
    }
    function saveObj() {
        const id=document.getElementById("eoId").value, isFixed=document.getElementById("eoFixed").checked;
        const paliers=[];
        if(!isFixed) {
            [1,2,3].forEach(i => { const t=document.getElementById("p"+i+"t").value, p=document.getElementById("p"+i+"p").value; if(t) paliers.push({ threshold:parseFloat(t), prize:parseFloat(p)||0 }); });
        } else { paliers.push({ threshold:100, prize:parseFloat(document.getElementById("eoFixedPrize").value)||0 }); }
        db.ref('objectives/'+id).update({
            name:document.getElementById("eoName").value, current:document.getElementById("eoCurrent").value, target:document.getElementById("eoTarget").value,
            isPrimary:document.getElementById("eoPrimary").checked, isInverse:document.getElementById("eoInverse").checked, isNumeric:document.getElementById("eoNumeric").checked, isFixed:isFixed,
            hideTarget:document.getElementById("eoHideTarget").checked, hideCurrent:document.getElementById("eoHideCurrent").checked, paliers:paliers
        });
        document.getElementById("editObjPanel").classList.remove("active");
    }

    // SIMULATOR
    function renderSimulator() {
        document.getElementById("simGlobalBudget").value = globalSettings.budget || 0;
        const container = document.getElementById("simObjList"); container.innerHTML = "";
        let used = 0; let totalUser = 0;
        
        Object.entries(allObjs).forEach(([k, o]) => {
           let maxP = 0; if(o.paliers) o.paliers.forEach(p => maxP += parse(p.prize));
           totalUser += maxP;
           
           const row = document.createElement("div"); row.style.cssText = "background:white; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #e2e8f0;";
           let html = `<div style="display:flex; justify-content:space-between; font-size:12px; font-weight:700; margin-bottom:5px;"><span>${o.name}</span><span style="color:${o.published?'#16a34a':'#dc2626'}">${o.published?'Publi√©':'Brouillon'}</span></div>`;
           
           if(o.isFixed) {
               html += `<div style="display:flex; align-items:center; gap:5px;"><input type="range" min="0" max="500" value="${(o.paliers&&o.paliers[0])?o.paliers[0].prize:0}" oninput="updateObjPrize('${k}', 0, this.value)"><span style="font-size:11px; font-weight:700; width:40px;">${(o.paliers&&o.paliers[0])?o.paliers[0].prize:0}‚Ç¨</span></div>`;
           } else {
               (o.paliers||[]).forEach((p, i) => {
                   html += `<div style="display:flex; align-items:center; gap:5px; margin-bottom:2px;"><span style="font-size:10px; color:#64748b; width:30px;">P${i+1}</span><input type="range" min="0" max="200" value="${p.prize}" oninput="updateObjPrize('${k}', ${i}, this.value)"><span style="font-size:11px; font-weight:700; width:40px;">${p.prize}‚Ç¨</span></div>`;
               });
           }
           // Toggle Publish
           html += `<div style="margin-top:5px; text-align:right;"><button onclick="togglePub('${k}', ${!o.published})" style="font-size:10px; background:${o.published?'#fca5a5':'#bbf7d0'}; border:none; padding:3px 8px; border-radius:4px; cursor:pointer; color:#1e293b; font-weight:700;">${o.published?'Masquer':'Publier'}</button></div>`;
           row.innerHTML = html; container.appendChild(row);
        });

        // Calc total budget used (Simulation based on 100% success for all users)
        let totalHours = 0; Object.values(allUsers).forEach(u => totalHours += (u.hours||0));
        used = totalUser * (totalHours / BASE_HOURS); // Approx global cost max
        
        document.getElementById("simUsed").textContent = used.toFixed(0) + "‚Ç¨ Max";
        const left = (globalSettings.budget || 0) - used;
        document.getElementById("simLeft").textContent = "Marge: " + left.toFixed(0) + "‚Ç¨";
        const gauge = document.getElementById("simGauge");
        let pct = (globalSettings.budget>0) ? (used/globalSettings.budget)*100 : 0;
        gauge.style.width = Math.min(pct, 100) + "%";
        gauge.style.background = pct > 100 ? "#ef4444" : "#2563eb";
    }

    function updateObjPrize(id, idx, val) {
        const o = allObjs[id]; if(!o || !o.paliers) return;
        if(o.paliers[idx]) o.paliers[idx].prize = parseFloat(val);
        db.ref('objectives/'+id).update({ paliers: o.paliers });
    }
    function togglePub(id, state) { db.ref('objectives/'+id).update({ published: state }); }
    function saveGlobalBudget() { db.ref('settings').update({ budget: parseFloat(document.getElementById("simGlobalBudget").value) }); }
    function publishSim() { if(confirm("Valider ces montants pour tout le monde ?")) showToast("‚úÖ Primes mises √† jour !"); }

    // UPDATES & FEEDBACK
    function renderUpdatesPublic() {
        const d = document.getElementById("publicUpdatesList"); d.innerHTML="";
        const arr = Object.values(allUpdates).sort((a,b)=>b.date-a.date);
        if(arr.length===0) { d.innerHTML="<div style='text-align:center;font-size:12px;color:#999;'>Aucune nouveaut√©.</div>"; return; }
        arr.forEach(u => {
            const c = document.createElement("div"); c.className="update-card";
            let tagCls="tag-new"; if(u.type==='fix') tagCls="tag-fix"; if(u.type==='impr') tagCls="tag-impr";
            let tagTxt="‚ú® Nouveaut√©"; if(u.type==='fix') tagTxt="üêõ Correctif"; if(u.type==='impr') tagTxt="üöÄ Am√©lioration";
            c.innerHTML=`<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span class="update-tag ${tagCls}">${tagTxt}</span><span style="font-size:10px; color:#999;">${new Date(u.date).toLocaleDateString()}</span></div><div style="font-weight:800; font-size:13px; margin-bottom:3px;">${u.title}</div><div style="font-size:12px; color:#555; white-space:pre-line;">${u.desc}</div>`;
            d.appendChild(c);
        });
    }
    function sendFeedback() {
        const t=document.getElementById("fbContent").value; if(!t) return;
        db.ref('feedbacks').push({ user:currentUser.name, msg:t, date:Date.now() });
        document.getElementById("fbContent").value=""; document.getElementById("feedbackModal").style.display="none"; showToast("Message envoy√© !");
    }
    function saveUpdate() {
        const t=document.getElementById("uptTitle").value, d=document.getElementById("uptDesc").value, ty=document.getElementById("uptType").value;
        if(t && d) { db.ref('updates').push({ title:t, desc:d, type:ty, date:Date.now() }); cancelUpdateEdit(); showToast("Publi√© !"); }
    }
    function cancelUpdateEdit() { document.getElementById("uptTitle").value=""; document.getElementById("uptDesc").value=""; }
    function renderUpdatesAdmin() {
        const d=document.getElementById("adminUpdatesList"); d.innerHTML="";
        Object.entries(allUpdates).sort((a,b)=>b[1].date-a[1].date).forEach(([k,u])=>{
             const div=document.createElement("div"); div.className="update-card";
             div.innerHTML=`<div style="font-weight:800;">${u.title} <button onclick="db.ref('updates/${k}').remove()" style="float:right; border:none; background:none; color:red;">√ó</button></div><div style="font-size:11px;">${u.desc}</div>`;
             d.appendChild(div);
        });
    }

    // CALENDAR LOGIC
    const calEvents = [
        { t: "HEIKO x STURIA", start: "2025-12-01", end: "2026-01-31", c: "evt-heiko" },
        { t: "BOGOF Deliveroo", start: "2025-12-08", end: "2025-12-14", c: "evt-deliv" },
        { t: "BOGOF UberEats", start: "2025-12-15", end: "2025-12-21", c: "evt-uber" }
    ];
    let currentCalDate = new Date(2025, 11, 1);
    function renderNativeCalendar() {
       const y=currentCalDate.getFullYear(), m=currentCalDate.getMonth();
       document.getElementById("calTitle").textContent = new Date(y,m,1).toLocaleDateString('fr-FR', {month:'long', year:'numeric'}).toUpperCase();
       const firstDay = new Date(y, m, 1).getDay() || 7; 
       const daysInMonth = new Date(y, m+1, 0).getDate();
       const grid = document.getElementById("calGrid"); grid.innerHTML="";
       for(let i=1; i<firstDay; i++) grid.appendChild(document.createElement("div"));
       for(let d=1; d<=daysInMonth; d++) {
           const cell = document.createElement("div"); cell.className="cal-cell";
           let dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
           let html = `<span class="cal-date">${d}</span>`;
           calEvents.forEach(e => {
               if(dateStr >= e.start && dateStr <= e.end) html += `<span class="cal-event-dot ${e.c}">${e.t}</span>`;
           });
           cell.innerHTML=html; grid.appendChild(cell);
       }
    }
    function prevMonth() { currentCalDate.setMonth(currentCalDate.getMonth()-1); renderNativeCalendar(); }
    function nextMonth() { currentCalDate.setMonth(currentCalDate.getMonth()+1); renderNativeCalendar(); }
  </script>
</body>
</html>
