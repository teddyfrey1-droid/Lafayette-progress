<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="manifest.webmanifest">
  <title>Pulse Dashboard - Lafayette</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="dark-mode"> <div id="topAlert">
      <div class="alert-icon">ğŸ“£</div>
      <div class="alert-content">
          <div class="alert-title">NOUVEAUTÃ‰ !</div>
          <div class="alert-desc" id="topAlertText">...</div>
      </div>
  </div>

  <div id="toast">âœ… Action effectuÃ©e !</div>

  <div id="loginOverlay">
    <div class="brand-logo-login">
       <img src="assets/icons/icon-192.png" alt="Pulse" style="width:80px; border-radius:20px; box-shadow:0 10px 30px rgba(217,70,239,0.3);">
    </div>
    <h1 style="font-size: 24px; font-weight: 900; color: white; margin: 20px 0 30px; letter-spacing: -0.5px;">PULSE DASHBOARD</h1>
    <div class="login-box glass-panel">
      <h2 class="login-title">Connexion</h2>
      <div class="input-group">
          <input type="email" id="loginEmail" placeholder="Email" oninput="clearLoginError()">
      </div>
      <div class="input-group">
          <input type="password" id="loginPass" placeholder="Mot de passe" oninput="clearLoginError()">
          <span class="toggle-password" onclick="togglePass()">ğŸ‘ï¸</span>
      </div>
      <button class="btn-pulse-primary" id="btnLogin">SE CONNECTER</button>
    </div>
  </div>

  <div id="appContent" class="dashboard-layout">
    
    <aside class="sidebar glass-panel">
      <div class="sidebar-header">
        <div class="app-brand">
           <span class="brand-icon">âš¡</span> 
           <span class="brand-name">PULSE</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#dashboard" class="nav-item active">
           <span class="nav-icon">ğŸ“Š</span> Dashboard
        </a>
        <a href="diffusion.html" class="nav-item">
           <span class="nav-icon">ğŸ“¢</span> Diffusion
        </a>
        <button onclick="openHistoryModalFromMenu()" class="nav-item button-link">
           <span class="nav-icon">ğŸ•’</span> Historique
        </button>
        <button onclick="toggleMenuSites()" class="nav-item button-link">
           <span class="nav-icon">ğŸ”—</span> Sites Utiles
        </button>
        <div id="menuSitesSub" style="display:none; padding-left:20px; margin-bottom:10px;">
           <div id="menuSitesPreview" class="mini-list"></div>
        </div>
        
        <button onclick="toggleMenuContacts()" class="nav-item button-link">
           <span class="nav-icon">ğŸ“</span> Contacts
        </button>
        <div id="menuContactsSub" style="display:none; padding-left:20px;">
           <div id="menuContactsPreview" class="mini-list"></div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button id="btnAdmin" class="nav-item admin-link" style="display:none;" onclick="toggleAdmin(true)">
           <span class="nav-icon">âš™ï¸</span> ADMIN
        </button>
        <button id="logoutBtn" onclick="logout()" class="nav-item logout-link">
           <span class="nav-icon">ğŸšª</span> DÃ©connexion
        </button>
      </div>
    </aside>

    <main class="main-content">
      
      <div class="mobile-header">
         <div class="app-brand-mobile">âš¡ PULSE</div>
         <button class="icon-btn-glass" id="globalMenuBtn" onclick="toggleGlobalMenu()">â˜°</button>
      </div>

      <header class="content-header">
        <div class="user-info-group">
           <h2 class="welcome-text">Bonjour, <span id="userName" class="text-gradient">--</span></h2>
           <span class="user-badge glass-badge" id="userHours">--h</span>
        </div>
        <div class="header-tools">
           <button class="icon-btn-glass" onclick="openUpdatesModalFromMenu()">ğŸ””</button>
           <div class="theme-toggle-mini" onclick="toggleDarkMode()">ğŸŒ™</div>
        </div>
      </header>

      <section class="score-section">
         <div class="score-card glass-panel" id="scoreCircle">
            <div class="money-rain" id="moneyRain"></div>
            <div class="score-ring">
               <div class="score-content">
                  <span class="score-label" id="globalScoreLabel">PRIMES DÃ‰BLOQUÃ‰ES</span>
                  <h1 class="score-value text-gradient" id="myTotalGain">0â‚¬</h1>
                  <div class="score-pending" id="pendingGain">â³ 0â‚¬ en attente</div>
               </div>
            </div>
            <div class="score-footer">
               <div class="pulse-micro" id="microMotiv">â€”</div>
            </div>
         </div>
      </section>

      <section class="kpi-grid" id="kpiStrip">
         <div class="kpi-card glass-panel">
            <div class="kpi-icon">ğŸ¯</div>
            <div class="kpi-data">
               <span class="kpi-label">Objectifs</span>
               <span class="kpi-val" id="kpiActiveObjs">0</span>
            </div>
         </div>
         <div class="kpi-card glass-panel">
            <div class="kpi-icon">ğŸ’</div>
            <div class="kpi-data">
               <span class="kpi-label">Bonus</span>
               <span class="kpi-val small" id="kpiBonusState">â€”</span>
            </div>
         </div>
         <div class="kpi-card glass-panel">
            <div class="kpi-icon">ğŸ“…</div>
            <div class="kpi-data">
               <span class="kpi-label">Jours restants</span>
               <div class="month-countdown-mini" id="monthCountdown">--</div>
            </div>
         </div>
      </section>

      <div class="focus-pill glass-panel" id="focusPill" style="display:none;">
        <span class="focus-emoji" id="focusEmoji">ğŸ”¥</span>
        <span class="focus-text" id="focusText">...</span>
      </div>
      
      <div class="trajectory-pill" id="trajectoryIndicator" style="display:none;">â€”</div>

      <div class="section-title">Objectifs du mois</div>
      <div class="objectives-wrapper" id="cardsContainer">
        <div style="text-align:center; opacity:0.5; margin-top:40px;">Chargement...</div>
      </div>

      <div class="section-title" style="margin-top:40px;">Planning</div>
      <div class="native-cal-container glass-panel">
          <div class="cal-header">
             <button class="cal-nav-btn" onclick="prevMonth()">â®</button>
             <div class="cal-month-title" id="calTitle">MOIS</div>
             <button class="cal-nav-btn" onclick="nextMonth()">â¯</button>
          </div>
          <div class="cal-grid header-row">
             <div>LUN</div><div>MAR</div><div>MER</div><div>JEU</div><div>VEN</div><div>SAM</div><div>DIM</div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
          <div class="cal-legend" id="calLegend"></div>
      </div>

      <div style="height:100px;"></div>
    </main>
  </div>

  <div class="global-menu-backdrop" id="globalMenuBackdrop" onclick="toggleGlobalMenu(false)"></div>
  <aside class="global-menu" id="globalMenu">
     <div class="global-menu-head">
        <span class="brand-name">MENU</span>
        <button class="icon-btn" onclick="toggleGlobalMenu(false)">âœ•</button>
     </div>
     <nav class="global-menu-links">
        <a href="index.html" class="global-menu-link">ğŸ“Š Dashboard</a>
        <a href="diffusion.html" class="global-menu-link">ğŸ“¢ Diffusion</a>
        <button onclick="openHistoryModalFromMenu()" class="global-menu-link">ğŸ•’ Historique</button>
        <button onclick="location.href='contacts.html'" class="global-menu-link">ğŸ“‡ Contacts</button>
        <button id="btnEnablePush" onclick="enableNotifications()" class="global-menu-link">ğŸ”” Activer Notifs</button>
        <button onclick="logout()" class="global-menu-link" style="color:#ef4444; margin-top:20px;">DÃ©connexion</button>
     </nav>
  </aside>

  <div id="updatesModal" class="modal-overlay"><div class="modal-box"><div id="publicUpdatesList"></div><button onclick="document.getElementById('updatesModal').style.display='none'" class="btn-close-modal">Fermer</button></div></div>
  <div id="historyModal" class="modal-overlay"><div class="modal-box"><div class="modal-title">Historique <button onclick="document.getElementById('historyModal').style.display='none'">Ã—</button></div><div id="historyModalList"></div></div></div>
  
  <div class="admin-panel" id="adminPanel">
    <button class="close-admin" onclick="toggleAdmin(false)">Ã—</button>
    <h2 style="margin-bottom:20px;">Manager</h2>
    <div class="tab-nav">
      <button id="btnTabTeam" onclick="switchTab('team')" class="btn-tab active">ğŸ‘¥ Ã‰quipe</button>
      <button id="btnTabObjs" onclick="switchTab('objs')" class="btn-tab">ğŸ¯ Pilotage</button>
      <button id="btnTabEmails" onclick="switchTab('emails')" class="btn-tab">ğŸ“§ Emails</button>
      <button id="btnTabLogs" onclick="switchTab('logs')" class="btn-tab">Logs</button>
    </div>
    
    <div id="tab-team">
       <div class="admin-section">
          <h3>Nouveau Membre</h3>
          <input type="text" id="nuName" placeholder="Nom" class="input-glass">
          <input type="email" id="nuEmail" placeholder="Email" class="input-glass" style="margin-top:10px;">
          <input type="number" id="nuHours" placeholder="Heures" class="input-glass" style="margin-top:10px;">
          <label class="check-label" style="margin-top:10px;"><input type="checkbox" id="nuAdmin"> Admin?</label>
          <button class="btn-pulse-primary" onclick="createUser()" style="margin-top:10px;">CrÃ©er</button>
       </div>
       <div class="admin-section">
          <h3>Effectif</h3>
          <div id="usersList"></div>
       </div>
    </div>
    <div id="tab-objs" style="display:none;">
       <div class="admin-section" id="superAdminBudget">
          <h3>Pilotage</h3>
          <label>Budget Max</label> <input type="number" id="simGlobalBudget" class="input-glass">
          <label>CA Mensuel</label> <input type="number" id="simMonthlyCA" class="input-glass">
          <div id="simObjList" style="margin-top:15px;"></div>
          <div id="simTotalPerUser" style="font-weight:bold; margin:10px 0;">0â‚¬</div>
          <button class="btn-pulse-primary" onclick="publishSim()">Publier</button>
       </div>
       <div class="admin-section">
          <h3>Ajouter Objectif</h3>
          <input type="text" id="noName" placeholder="Nom" class="input-glass">
          <input type="text" id="noTarget" placeholder="Cible" class="input-glass" style="margin-top:5px;">
          <div style="display:flex; gap:10px; margin-top:5px;">
             <label><input type="checkbox" id="noPrimary" checked> Principal</label>
             <label><input type="checkbox" id="noFixed"> Fixe</label>
             <label><input type="checkbox" id="noNumeric"> Nombre</label>
          </div>
          <div id="createTiersBlock" style="margin-top:10px;">
             <input type="number" id="c_p1t" placeholder="P1"> <input type="number" id="c_p2t" placeholder="P2"> <input type="number" id="c_p3t" placeholder="P3">
          </div>
          <button onclick="addObj()" class="btn-pulse-primary" style="margin-top:10px;">Ajouter</button>
       </div>
       <div id="pubList"></div>
       <div id="quickUpdateList"></div>
    </div>
    <div id="tab-emails" style="display:none;">
        <div class="admin-section">
           <h3>Envoi Email</h3>
           <input type="text" id="mailSubject" placeholder="Sujet" class="input-glass">
           <textarea id="mailMessage" placeholder="Message..." class="input-glass" style="height:100px; margin-top:5px;"></textarea>
           <button class="btn-pulse-primary" onclick="sendManualEmail()" style="margin-top:10px;">Envoyer</button>
           <div id="mailUsersGrid" style="margin-top:10px;"></div>
           <div id="mailQuickGroups"></div>
           <div id="mailGroupsList"></div>
        </div>
    </div>
    <div id="tab-logs" style="display:none;"><div id="logsContainer"></div></div>
    <div id="tab-feedbacks" style="display:none;"><div id="feedbacksContainer"></div></div>
  </div>

  <div id="userEditModal" class="modal-overlay"><div class="modal-box">
     <h3>Modifier Membre</h3>
     <input type="hidden" id="uemUid">
     <input type="text" id="uemName" placeholder="Nom" class="input-glass">
     <input type="email" id="uemEmail" placeholder="Email" class="input-glass" style="margin-top:10px;">
     <input type="number" id="uemHours" placeholder="Heures" class="input-glass" style="margin-top:10px;">
     <label style="margin-top:10px; display:block;"><input type="checkbox" id="uemAdmin"> Admin</label>
     <button onclick="saveUserEditModal()" class="btn-pulse-primary" style="margin-top:15px;">Sauver</button>
     <button onclick="closeUserEditModal()" class="btn-glass-secondary" style="margin-top:10px;">Annuler</button>
     <div style="display:none;"><span id="uemStatus"></span><span id="uemPush"></span></div>
  </div></div>

  <div id="editObjPanel" class="admin-panel" style="z-index:2200;">
     <h3>Modifier Objectif</h3>
     <input type="hidden" id="eoId">
     <input type="text" id="eoName" class="input-glass">
     <input type="text" id="eoCurrent" placeholder="Actuel" class="input-glass" style="margin-top:5px;">
     <input type="text" id="eoTarget" placeholder="Cible" class="input-glass" style="margin-top:5px;">
     <div style="display:flex; gap:10px; margin-top:10px;">
        <label><input type="checkbox" id="eoPrimary"> Principal</label>
        <label><input type="checkbox" id="eoFixed"> Fixe</label>
        <label><input type="checkbox" id="eoNumeric"> Nombre</label>
        <label><input type="checkbox" id="eoInverse"> InversÃ©</label>
     </div>
     <div id="editTiersBlock" style="margin-top:10px;">
        <input type="number" id="p1t"> <input type="number" id="p2t"> <input type="number" id="p3t">
        <input type="hidden" id="p1p"><input type="hidden" id="p2p"><input type="hidden" id="p3p"><input type="hidden" id="eoFixedPrize">
     </div>
     <div style="margin-top:10px;">
        <label><input type="checkbox" id="eoHideTarget"> Cacher Cible</label>
        <label><input type="checkbox" id="eoHideCurrent"> Cacher Valeur</label>
     </div>
     <button onclick="saveObj()" class="btn-pulse-primary" style="margin-top:15px;">Sauver</button>
     <button onclick="document.getElementById('editObjPanel').classList.remove('active')" class="btn-glass-secondary" style="margin-top:10px;">Annuler</button>
  </div>
  
  <div id="mailGroupModal" class="modal-overlay"><div class="modal-box">
     <h3 id="mailGroupModalTitle">Groupe</h3>
     <input type="hidden" id="mailGroupId">
     <input type="text" id="mailGroupName" class="input-glass">
     <input type="color" id="mailGroupColor">
     <div id="mailGroupMembers"></div>
     <button id="mailGroupSaveBtn" onclick="saveMailGroup()" class="btn-pulse-primary">Sauver</button>
     <button onclick="closeMailGroupModal()" class="btn-glass-secondary">Fermer</button>
  </div></div>

  <script src="assets/js/app.js"></script>
  <script src="assets/js/email.js"></script>
</body>
</html>
