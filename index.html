<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  
  <title>Heiko - Budget Master V64 (Pro Design)</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    /* --- VARIABLES & THEMES --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --card-bg: #ffffff;
      --text-main: #1e293b; 
      --text-muted: #64748b;
      --border-color: #cbd5e1;
      --input-bg: #ffffff;
      
      --primary: #2563eb; 
      --accent: #f59e0b;
      --success: #10b981; 
      --success-dark: #047857; /* Vert plus sombre et pro */
      --danger: #ef4444;
      --radius: 24px;
      --font-stack: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    /* DARK MODE VARIABLES */
    body.dark-mode {
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --input-bg: #0f172a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-stack); background: var(--bg-gradient); color: var(--text-main); min-height: 100vh; padding: 20px; overflow-x: hidden; transition: background 0.4s ease, color 0.4s ease; }

    /* ANIMATIONS */
    @keyframes moneyFountain { 
        0% { transform: translate(-50%, 0) scale(0.5) rotate(0deg); opacity: 0; } 
        20% { opacity: 1; }
        50% { transform: translate(calc(-50% + var(--rx)), -120px) scale(1) rotate(180deg); }
        100% { transform: translate(calc(-50% + var(--rx2)), 200px) scale(1) rotate(360deg); opacity: 0; }
    }

    @keyframes moveStripes { 0% { background-position: 0 0; } 100% { background-position: 50px 0; } }
    
    /* ANIMATION BORDURE CLASSE (Flowing Gradient) */
    @keyframes borderRotate {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }

    /* ALERT TOP */
    @keyframes slideDownUp {
        0% { transform: translate(-50%, -200%); opacity: 0; }
        5% { transform: translate(-50%, 20px); opacity: 1; }
        95% { transform: translate(-50%, 20px); opacity: 1; }
        100% { transform: translate(-50%, -200%); opacity: 0; }
    }

    #topAlert {
        position: fixed; top: 0; left: 50%; transform: translate(-50%, -200%);
        background: var(--card-bg); z-index: 4000;
        padding: 15px 25px; border-radius: 50px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        display: flex; align-items: center; gap: 15px;
        border: 1px solid var(--border-color);
        min-width: 320px; max-width: 90%;
    }
    #topAlert.trigger { animation: slideDownUp 10s forwards ease-in-out; }
    .alert-icon { font-size: 24px; }
    .alert-title { font-weight: 800; color: var(--text-main); font-size: 14px; text-transform: uppercase; }
    .alert-desc { font-size: 12px; color: var(--text-muted); font-weight:600; }

    /* TOAST */
    #toast { visibility: hidden; min-width: 280px; background-color: var(--success-dark); color: #fff; text-align: center; border-radius: 50px; padding: 14px; position: fixed; z-index: 3000; left: 50%; top: 20px; font-weight: 700; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform:translate(-50%, -100%); transition: all 0.3s; opacity:0; }
    #toast.show { visibility: visible; transform:translate(-50%, 0); opacity:1; }

    /* --- NOUVEAU SWITCH MODE NUIT (Design "Barre" Classy) --- */
    .theme-switch-container {
        position: fixed; bottom: 25px; right: 25px; z-index: 9999;
    }
    .theme-switch {
        width: 76px; height: 40px; /* Plus large pour le style */
        background-color: #e2e8f0; /* Gris clair soft */
        border-radius: 50px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.4s ease;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.05), 0 5px 15px rgba(0,0,0,0.1);
        border: 1px solid #cbd5e1;
    }
    
    /* Curseur (Le rond) */
    .theme-knob {
        width: 32px; height: 32px;
        background-color: white;
        border-radius: 50%;
        position: absolute;
        top: 3px; left: 4px;
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Effet rebond fluide */
        display: flex; align-items: center; justify-content: center;
        font-size: 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        color: #64748b;
    }

    /* ETAT DARK MODE */
    body.dark-mode .theme-switch {
        background-color: #1e293b; /* Bleu nuit fond */
        border-color: #334155;
    }
    body.dark-mode .theme-knob {
        transform: translateX(34px); /* Glisse √† droite */
        background-color: #334155;
        color: #fbbf24; /* Jaune soleil */
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    /* FEEDBACK BUTTON */
    .feedback-btn {
        position: fixed; top: 50%; right: 0; transform: translateY(-50%);
        background: var(--accent); color: white; border: none;
        padding: 12px 18px; border-radius: 30px 0 0 30px;
        box-shadow: -4px 4px 15px rgba(245, 158, 11, 0.2);
        cursor: pointer; z-index: 1000;
        font-weight: 800; font-size: 13px;
        transition: all 0.3s ease;
    }
    .feedback-btn:hover { padding-right: 22px; background: #d97706; }
    
    /* MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2500; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
    .modal-box { background: var(--card-bg); padding: 30px; border-radius: 24px; width: 100%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 85vh; overflow-y: auto; border: 1px solid var(--border-color); }
    .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display:flex; justify-content:space-between; align-items:center; }
    textarea.fb-input { width: 100%; height: 120px; padding: 15px; border: 2px solid var(--border-color); background: var(--input-bg); color: var(--text-main); border-radius: 16px; resize: none; font-family: inherit; font-size: 14px; margin-bottom: 20px; outline: none; transition:border-color 0.3s; }
    textarea.fb-input:focus { border-color: var(--primary); }

    /* UPDATES STYLE */
    .update-card { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; margin-bottom: 12px; }
    .update-tag { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; }
    .tag-new { background: #dcfce7; color: #166534; }
    .tag-fix { background: #fee2e2; color: #991b1b; }
    .tag-impr { background: #dbeafe; color: #1e40af; }

    /* LOGIN */
    #loginOverlay { position: fixed; inset: 0; background: var(--bg-gradient); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
    .login-box { background: var(--card-bg); padding: 40px; border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); width: 100%; max-width: 380px; text-align: center; border: 1px solid var(--border-color); }
    .input-group { position: relative; margin-bottom: 15px; }
    input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border-color); font-size: 14px; background: var(--input-bg); color: var(--text-main); outline: none; transition: 0.3s; font-weight:500; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    input.error { border-color: var(--danger); animation: shake 0.3s; background-color: rgba(239, 68, 68, 0.05); }

    #appContent { display: none; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; position: relative; z-index: 50; flex-wrap: wrap; gap:10px; }
    .user-welcome { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .user-badge { background: #eff6ff; color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 800; border:1px solid #dbeafe; }
    body.dark-mode .user-badge { background: #1e3a8a; border-color:#1e40af; color: #bfdbfe; }

    .container { max-width: 1100px; margin: 0 auto; padding-bottom: 120px; }
    
    header { text-align: center; margin-bottom: 50px; position: relative; z-index: 10; } 
    .header-pill { display: inline-flex; align-items: center; gap: 8px; background: white; padding: 8px 16px; border-radius: 50px; font-size: 11px; font-weight: 900; color: var(--primary); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; border: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
    body.dark-mode .header-pill { background: #1e293b; color: #93c5fd; }
    h1 { font-size: 42px; font-weight: 900; color: var(--text-main); margin: 0 0 10px; letter-spacing: -1px; text-transform: uppercase; line-height: 0.95; }
    .last-update { font-size: 13px; color: var(--text-muted); padding: 6px 15px; border-radius: 20px; display: inline-block; font-weight: 600; background: rgba(0,0,0,0.03); }

    /* MONEY CIRCLE */
    .global-score-container { 
        margin: 40px auto; width: 260px; height: 260px; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; flex-direction: column; 
        position: relative; overflow: visible; 
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 25px 60px -10px rgba(37, 99, 235, 0.25);
    }
    
    .score-inner-mask { position: absolute; inset: 5px; border-radius: 50%; overflow: hidden; z-index: 0; background: var(--input-bg); }
    .score-fill-level {
        position: absolute; bottom: 0; left: 0; right: 0; height: 0%;
        background-color: #dcfce7;
        background-image: radial-gradient(#10b981 1px, transparent 1px);
        background-size: 10px 10px;
        transition: height 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0.4; border-top: 3px solid #10b981;
    }
    body.dark-mode .score-fill-level { background-color: #064e3b; opacity:0.5; }

    .global-score-value { font-size: 52px; font-weight: 900; color: var(--success-dark); line-height: 1; z-index: 2; position: relative; letter-spacing:-2px; }
    body.dark-mode .global-score-value { color: #34d399; }
    .global-score-label { font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; letter-spacing: 1px; z-index: 2; position: relative; }
    .money-rain { position: absolute; inset: 0; pointer-events: none; z-index: 10; width: 100%; height: 100%; overflow: visible; }
    .bill { position: absolute; font-size: 24px; opacity: 0; user-select:none; }

    .objectives-wrapper { display: flex; flex-direction: column; gap: 40px; }
    .category-title { font-size: 20px; font-weight: 900; text-transform: uppercase; color: var(--text-main); margin: 0 0 20px; display: flex; align-items: center; gap: 15px; letter-spacing: 0.5px; opacity:0.8; }
    
    /* --- CARTE OBJECTIF --- */
    .card { 
        background: var(--card-bg); border-radius: var(--radius); padding: 30px; 
        box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); 
        position: relative; overflow: hidden; 
        border: 1px solid var(--border-color); 
        margin-bottom: 20px; transition: transform 0.2s; z-index:0; 
    }
    .card.is-locked { background: #f8fafc; border: 2px dashed #cbd5e1; opacity: 0.8; box-shadow:none; }
    body.dark-mode .card.is-locked { background: #0f172a; border-color: #334155; }
    .card.is-locked .obj-icon { filter: grayscale(1); opacity: 0.5; }

    /* --- NOUVELLE BORDURE "CLASSY" --- */
    /* On utilise un d√©grad√© qui bouge pour un effet vivant mais pro */
    .card.is-winner {
        border: 3px solid transparent; /* Transparent pour laisser voir le background en dessous */
        background: linear-gradient(var(--card-bg), var(--card-bg)) padding-box,
                    linear-gradient(45deg, #047857, #10b981, #065f46, #047857) border-box; /* Vert Profond */
        background-size: 300% 300%;
        animation: borderRotate 6s ease infinite; /* Animation fluide et lente */
        box-shadow: 0 15px 40px -10px rgba(6, 95, 70, 0.25); /* Ombre port√©e verte sombre */
    }
    /* Dark mode ajustement */
    body.dark-mode .card.is-winner {
         background: linear-gradient(var(--card-bg), var(--card-bg)) padding-box,
                    linear-gradient(45deg, #059669, #34d399, #059669) border-box;
         box-shadow: 0 15px 40px -10px rgba(5, 150, 105, 0.3);
    }

    .status-badge { position: absolute; top: 0; left: 0; right: 0; padding: 10px; text-align: center; font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; }
    .badge-locked { background: #fff7ed; color: #c2410c; border-bottom: 1px solid #fed7aa; }
    .badge-winner { background: #ecfdf5; color: #047857; border-bottom: 1px solid #a7f3d0; }
    body.dark-mode .badge-winner { background: #064e3b; color: #d1fae5; border-color: #065f46; }
    .badge-ready { background: var(--accent); color: white; }

    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; margin-top: 20px; gap: 15px; }
    .obj-icon { width: 56px; height: 56px; border-radius: 16px; background: #f1f5f9; color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 26px; margin-right: 15px; flex-shrink: 0; border:1px solid var(--border-color); }
    body.dark-mode .obj-icon { background: #1e3a8a; border-color:#1e40af; color:white; }
    
    .data-boxes-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .data-box { flex: 1; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px 12px; display: flex; flex-direction: column; }
    .data-box-label { font-size: 9px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
    .data-box-value { font-size: 16px; font-weight: 900; color: var(--text-main); }

    /* BARRE DE PROGRESSION PRO */
    .progress-track { height: 24px; background: var(--border-color); border-radius: 12px; overflow: hidden; margin-bottom: 35px; position: relative; display: flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    
    .progress-fill { 
        height: 100%; 
        background-color: var(--primary);
        /* Rayures subtiles et pro */
        background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
        background-size: 200% 200%;
        animation: moveStripes 30s linear infinite; /* Ind√©finiment, mais lent et classe */
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    /* Quand gagn√©, barre verte sombre pro */
    .card.is-winner .progress-fill { background-color: var(--success-dark); }
    body.dark-mode .card.is-winner .progress-fill { background-color: #059669; }

    .progress-overdrive { height: 100%; background-color: var(--danger); opacity:0.8; }
    .percent-float { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 900; color: white; z-index: 5; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    .milestones { display: flex; justify-content: space-between; position: relative; padding: 0 10px; }
    .milestones::before { content: ''; position: absolute; top: 15px; left: 25px; right: 25px; height: 4px; background: var(--border-color); z-index: 0; border-radius: 4px; }
    .ms-item { z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; width: 30%; position: relative; }
    .ms-circle { width: 34px; height: 34px; background: var(--card-bg); border: 3px solid #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #94a3b8; transition: 0.3s; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .ms-item.unlocked .ms-circle { border-color: var(--success-dark); background: #ecfdf5; color: var(--success-dark); transform: scale(1.1); box-shadow: 0 4px 10px rgba(4, 120, 87, 0.2); }
    .ms-prize { font-size: 12px; background: var(--input-bg); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border-color); font-weight: 800; color: var(--text-muted); }
    .ms-item.unlocked .ms-prize { background: var(--success-dark); color: white; border-color: var(--success-dark); }
    .ms-threshold { position: absolute; top: -25px; font-size: 10px; font-weight: 800; color: var(--text-muted); background: var(--card-bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color); }

    .fixed-bonus-block { background: var(--input-bg); border: 1px dashed var(--border-color); border-radius: 12px; padding: 15px; text-align: center; color: var(--text-muted); font-weight: 700; }
    .fixed-bonus-block.unlocked { background: #ecfdf5; border: 2px solid #059669; color: #047857; }
    body.dark-mode .fixed-bonus-block.unlocked { background: #064e3b; border-color: #059669; color: #d1fae5; }

    .earned-badge-container { margin-top: 25px; display: flex; justify-content: center; }
    .earned-badge { background: #ecfdf5; color: #065f46; padding: 10px 20px; border-radius: 50px; font-weight: 800; font-size: 15px; border: 1px solid #10b981; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.15); }
    body.dark-mode .earned-badge { background: #064e3b; color: #a7f3d0; border-color: #059669; }

    /* CALENDAR */
    .native-cal-container { margin-top: 50px; background: var(--card-bg); border-radius: 24px; padding: 25px; box-shadow: 0 15px 40px -5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cal-month-title { font-size: 14px; font-weight: 900; text-transform: uppercase; color: var(--text-main); }
    .cal-nav-btn { background: var(--input-bg); border: 1px solid var(--border-color); width: 32px; height: 32px; border-radius: 50%; color: var(--text-main); font-weight: 900; cursor: pointer; display:flex; align-items:center; justify-content:center; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .cal-day-name { text-align: center; font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; padding-bottom: 8px; }
    .cal-cell { background: var(--input-bg); border-radius: 10px; min-height: 55px; padding: 4px; border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .cal-date { font-size: 11px; font-weight: 800; color: var(--text-main); margin-bottom: 4px; display: block; }
    .cal-event-dot { display: block; font-size: 9px; padding: 2px 5px; border-radius: 4px; margin-bottom: 3px; color: white; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* ADMIN */
    .admin-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 500px; background: var(--card-bg); z-index: 2000; box-shadow: -10px 0 50px rgba(0,0,0,0.1); padding: 25px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; border-left: 1px solid var(--border-color); }
    .admin-panel.active { transform: translateX(0); }
    .close-admin { position: absolute; top: 20px; right: 20px; font-size: 24px; background: none; border: none; cursor: pointer; color: var(--text-muted); }
    .admin-section { background: var(--input-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
    .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; background: var(--primary); color: white; font-size: 12px; letter-spacing: 0.5px; transition: 0.2s; box-shadow: 0 4px 12px rgba(37,99,235,0.2); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37,99,235,0.3); }
    
    .tab-nav { display: flex; gap: 8px; margin-bottom: 25px; padding: 4px; background: var(--input-bg); border-radius: 14px; border: 1px solid var(--border-color); }
    .btn-tab { flex:1; padding: 10px; font-size: 11px; font-weight: 800; color: var(--text-muted); background: transparent; border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; }
    .btn-tab.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

    .switch { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(18px); }

    .options-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 12px; border-radius: 12px; }
    .check-label { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 800; color: #1e3a8a; cursor: pointer; }
    
    /* COCKPIT */
    .cockpit-container { padding: 20px; border: 1px solid var(--border-color); border-radius: 20px; background: var(--input-bg); margin-bottom: 20px; }
    .cockpit-gauge-container { height: 20px; background: var(--border-color); border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
    .cockpit-gauge-fill { height: 100%; width: 0; background: var(--primary); transition: width 0.3s; }
    input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: var(--border-color); border-radius: 5px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--primary); margin-top: -9px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 2px solid white; }
  </style>
</head>
<body>

  <div class="theme-switch-container">
      <div class="theme-switch" onclick="toggleDarkMode()">
          <div class="theme-knob" id="themeKnobIcon">üåô</div> 
      </div>
  </div>

  <div id="topAlert">
      <div class="alert-icon">üì£</div>
      <div class="alert-content">
          <div class="alert-title">NOUVEAUT√â !</div>
          <div class="alert-desc" id="topAlertText">...</div>
      </div>
  </div>

  <div class="feedback-btn" onclick="document.getElementById('feedbackModal').style.display='flex'">üí° Id√©e</div>

  <div id="feedbackModal" class="modal-overlay">
      <div class="modal-box">
          <div class="modal-title">üí° Bo√Æte √† id√©es <button onclick="document.getElementById('feedbackModal').style.display='none'" style="border:none;background:none;font-size:20px;cursor:pointer;">√ó</button></div>
          <textarea id="fbContent" class="fb-input" placeholder="Votre message..."></textarea>
          <button class="btn" onclick="sendFeedback()">Envoyer</button>
      </div>
  </div>

  <div id="updatesModal" class="modal-overlay">
      <div class="modal-box">
          <div class="modal-title"><span>üì¢ Nouveaut√©s</span> <button onclick="document.getElementById('updatesModal').style.display='none'" style="border:none;background:none;font-size:20px;cursor:pointer;">√ó</button></div>
          <div id="publicUpdatesList" style="display:flex; flex-direction:column; gap:10px;"></div>
      </div>
  </div>

  <div id="toast">‚úÖ Action effectu√©e !</div>

  <div id="loginOverlay">
    <h1 style="font-size: 24px; font-weight: 900; color: var(--text-main); margin-bottom: 30px; text-transform: uppercase;">üöÄ DASHBOARD<br>LAFAYETTE</h1>
    <div class="login-box">
      <h2 style="font-size:16px; margin-bottom:20px; text-transform:uppercase;">Connexion</h2>
      <div class="input-group"><input type="email" id="loginEmail" placeholder="Email" oninput="clearLoginError()"></div>
      <div class="input-group"><input type="password" id="loginPass" placeholder="Mot de passe" oninput="clearLoginError()"></div>
      <button class="btn" id="btnLogin">Entrer</button>
      <a onclick="resetPassword()" style="display:block; margin-top:15px; font-size:11px; color:var(--text-muted); text-decoration:underline; cursor:pointer;">Mot de passe oubli√© ?</a>
    </div>
  </div>

  <div id="appContent">
    <div class="top-bar">
      <div class="user-welcome">
        üë§ <span id="userName">--</span> 
        <span class="user-badge" id="userHours">--h</span>
        <button onclick="document.getElementById('updatesModal').style.display='flex'" style="border:none; background:rgba(37,99,235,0.1); color:var(--primary); border-radius:20px; padding:5px 10px; font-size:10px; font-weight:800; cursor:pointer; margin-left:5px;">üì¢</button>
      </div>
      <div style="display:flex; gap:10px;">
        <button id="btnAdmin" class="btn" style="width:auto; padding:8px 16px; font-size:11px; display:none;">‚öôÔ∏è</button>
        <button onclick="logout()" class="btn" style="width:auto; padding:8px 16px; font-size:11px; background:var(--input-bg); color:var(--danger); border:1px solid #fca5a5;">D√©co</button>
      </div>
    </div>

    <div class="container">
      <header>
        <div class="header-pill">üöÄ Dashboard Live</div>
        <h1>OBJECTIFS HEIKO</h1>
        <div class="last-update" id="lastUpdate">Chargement...</div>
        
        <div class="global-score-container" id="scoreCircle">
          <div class="score-inner-mask"><div class="score-fill-level" id="moneyFill"></div></div>
          <div class="money-rain" id="moneyRain"></div>
          <div class="global-score-value" id="myTotalGain">0‚Ç¨</div>
          <div class="global-score-label">PRIMES D√âBLOQU√âES</div>
        </div>
      </header>
      
      <div class="objectives-wrapper" id="cardsContainer">
        <div style="text-align:center; color:#9ca3af; margin-top:50px;">Chargement des donn√©es...</div>
      </div>

      <div class="category-title" style="margin-top:60px; justify-content:center;">Planning üìÖ</div>
      <div class="native-cal-container">
          <div class="cal-header">
             <button class="cal-nav-btn" onclick="prevMonth()">‚ùÆ</button>
             <div class="cal-month-title" id="calTitle">D√âCEMBRE 2025</div>
             <button class="cal-nav-btn" onclick="nextMonth()">‚ùØ</button>
          </div>
          <div class="cal-grid" style="margin-bottom:10px;">
             <div class="cal-day-name">L</div><div class="cal-day-name">M</div><div class="cal-day-name">M</div><div class="cal-day-name">J</div><div class="cal-day-name">V</div><div class="cal-day-name">S</div><div class="cal-day-name">D</div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
      </div>
    </div>
  </div>

  <div class="admin-panel" id="adminPanel">
    <button class="close-admin" onclick="toggleAdmin(false)">√ó</button>
    <h2 style="margin-bottom:20px;">Manager</h2>
    <div class="tab-nav">
      <button id="btnTabTeam" onclick="switchTab('team')" class="btn-tab active">üë• √âquipe</button>
      <button id="btnTabObjs" onclick="switchTab('objs')" class="btn-tab">üéØ Pilotage</button>
      <button id="btnTabLogs" onclick="switchTab('logs')" class="btn-tab" style="display:none;">üïí Logs</button>
      <button id="btnTabFeedbacks" onclick="switchTab('feedbacks')" class="btn-tab" style="display:none;">üí¨ Avis</button>
    </div>

    <div id="tab-team">
      <div class="admin-section">
        <h3>Ajouter Membre</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <input type="text" id="nuName" placeholder="Pr√©nom">
          <input type="number" id="nuHours" placeholder="Heures">
        </div>
        <input type="email" id="nuEmail" placeholder="Email" style="margin-top:10px;">
        <div style="margin:10px 0;"><input type="checkbox" id="nuAdmin"> Admin ?</div>
        <button class="btn" onclick="createUser()">Inviter</button>
      </div>
      <div class="admin-section">
        <h3>Effectif</h3>
        <div id="usersList"></div>
      </div>
    </div>

    <div id="tab-objs" style="display:none;">
      <div class="admin-section" id="superAdminBudget" style="border: 2px solid var(--primary);">
         <h3>üéõÔ∏è BUDGET & PILOTAGE</h3>
         <div class="cockpit-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
               <span style="font-size:11px; font-weight:700;">BUDGET GLOBAL</span>
               <input type="number" id="simGlobalBudget" style="width:80px; padding:4px;" oninput="updateSim()">
               <button onclick="saveGlobalBudget()" class="btn" style="width:auto; padding:5px;">OK</button>
            </div>
            <div class="cockpit-gauge-container"><div class="cockpit-gauge-fill" id="simGauge"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:11px;">
                <span id="simUsed">0‚Ç¨</span> <span id="simLeft">Reste: 0‚Ç¨</span>
            </div>
            <div id="simObjList" style="margin-top:15px;"></div>
            <div style="margin-top:15px; text-align:center; font-weight:900;">PRIME / T√äTE (35H): <span id="simTotalPerUser" style="color:var(--primary);">0‚Ç¨</span></div>
         </div>
         <button class="btn" onclick="publishSim()" style="background:var(--success-dark);">üì° PUBLIER CHANGEMENTS</button>
      </div>
      <div class="admin-section">
        <h3>Ajouter Objectif</h3>
        <input type="text" id="noName" placeholder="Nom" style="margin-bottom:10px;">
        <input type="text" id="noTarget" placeholder="Cible" style="margin-bottom:10px;">
        <div class="options-row">
            <label class="check-label"><input type="checkbox" id="noPrimary" checked> Principal</label>
            <label class="check-label"><input type="checkbox" id="noInverse"> Invers√©</label>
            <label class="check-label"><input type="checkbox" id="noNumeric"> Nombre</label>
            <label class="check-label"><input type="checkbox" id="noFixed" onchange="toggleCreateInputs()"> Fixe</label>
        </div>
        <div id="createTiersBlock">
            <label style="font-size:10px; font-weight:700;">Seuils (%)</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="c_p1t" placeholder="P1">
                <input type="number" id="c_p2t" placeholder="P2">
                <input type="number" id="c_p3t" placeholder="P3">
            </div>
        </div>
        <button class="btn" onclick="addObj()" style="margin-top:10px;">Cr√©er</button>
      </div>
      <div class="admin-section">
        <h3>Modifier Objectifs</h3>
        <div id="objList"></div>
      </div>
    </div>

    <div id="tab-logs" style="display:none;">
       <div class="admin-section" id="logsContainer"></div>
    </div>
    <div id="tab-feedbacks" style="display:none;">
       <div class="admin-section">
          <h3>Nouveaut√©s</h3>
          <input type="hidden" id="uptId">
          <input type="text" id="uptTitle" placeholder="Titre" style="margin-bottom:5px;">
          <textarea id="uptDesc" class="fb-input" style="height:60px;" placeholder="D√©tail..."></textarea>
          <select id="uptType" style="margin-bottom:10px;"><option value="new">Nouveaut√©</option><option value="fix">Correction</option></select>
          <button class="btn" id="btnSaveUpdate" onclick="saveUpdate()">Publier</button>
          <div id="adminUpdatesList" style="margin-top:15px;"></div>
       </div>
       <div class="admin-section" id="feedbacksContainer"></div>
    </div>
  </div>

  <div class="admin-panel" id="editObjPanel" style="z-index:2100; max-width:400px; border-left:4px solid var(--primary);">
    <h3>Modifier Objectif</h3>
    <input type="hidden" id="eoId">
    <input type="text" id="eoName" style="margin-bottom:10px;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
      <input type="text" id="eoCurrent" placeholder="Actuel">
      <input type="text" id="eoTarget" placeholder="Cible">
    </div>
    <div class="options-row">
        <label class="check-label"><input type="checkbox" id="eoPrimary"> Principal</label>
        <label class="check-label"><input type="checkbox" id="eoInverse"> Invers√©</label>
        <label class="check-label"><input type="checkbox" id="eoNumeric"> Nombre</label>
        <label class="check-label"><input type="checkbox" id="eoFixed" onchange="toggleEditInputs()"> Fixe</label>
    </div>
    <div id="editTiersBlock">
        <label style="font-size:10px;">PALIERS (seuils)</label>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="number" id="p1t"><input type="number" id="p2t"><input type="number" id="p3t">
        </div>
    </div>
    <input type="hidden" id="p1p"><input type="hidden" id="p2p"><input type="hidden" id="p3p"><input type="hidden" id="eoFixedPrize">
    <button class="btn" onclick="saveObj()">Sauvegarder</button>
    <button class="btn" onclick="document.getElementById('editObjPanel').classList.remove('active')" style="background:#cbd5e1; color:#333; margin-top:10px;">Annuler</button>
  </div>
  
  <div class="admin-panel" id="editUserPanel" style="z-index:2100; max-width:350px;">
      <h3>Editer Membre</h3>
      <input type="hidden" id="euId">
      <input type="text" id="euName" style="margin-bottom:10px;">
      <input type="number" id="euHours" style="margin-bottom:10px;">
      <input type="text" id="euEmail" disabled style="margin-bottom:10px; opacity:0.7;">
      <div style="margin-bottom:10px;"><input type="checkbox" id="euAdmin"> Admin</div>
      <button class="btn" onclick="saveUser()">Sauvegarder</button>
      <button class="btn" onclick="document.getElementById('editUserPanel').classList.remove('active')" style="background:#cbd5e1; color:#333; margin-top:10px;">Annuler</button>
  </div>

  <script>
    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAGaitqmFwExvJ9ZUpkdUdCKAqqDOP2cdQ",
      authDomain: "objectif-restaurant.firebaseapp.com",
      databaseURL: "https://objectif-restaurant-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "objectif-restaurant",
      storageBucket: "objectif-restaurant.firebasestorage.app",
      messagingSenderId: "910113283000",
      appId: "1:910113283000:web:0951fd9dca01aa6e46cd4d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let allUsers = {};
    let allObjs = {};
    let allLogs = {};
    let allFeedbacks = {};
    let allUpdates = {};
    let globalSettings = { budget: 0 };
    const BASE_HOURS = 35;
    const SUPER_ADMIN_EMAIL = "teddy.frey1@gmail.com";

    // CALENDAR DATA
    const calEvents = [
        { t: "HEIKO x STURIA", start: "2025-12-01", end: "2026-01-31", c: "#f59e0b" },
        { t: "Flyers", start: "2025-12-01", end: "2025-12-31", c: "#2563eb" },
        { t: "Promo Uber", start: "2025-12-15", end: "2025-12-21", c: "#10b981" }
    ];
    let currentCalDate = new Date(2025, 11, 1);

    // --- THEME LOGIC UPDATED ---
    function initTheme() {
        const isDark = localStorage.getItem('heiko_dark_mode') === 'true';
        if(isDark) document.body.classList.add('dark-mode');
        updateThemeIcon(isDark);
    }
    
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('heiko_dark_mode', isDark);
        updateThemeIcon(isDark);
    }
    
    function updateThemeIcon(isDark) {
        // En mode nuit, le curseur est √† droite et affiche le Soleil (pour repasser jour)
        // En mode jour, le curseur est √† gauche et affiche la Lune (pour passer nuit)
        const knob = document.getElementById('themeKnobIcon');
        knob.innerHTML = isDark ? '‚òÄÔ∏è' : 'üåô';
    }
    initTheme();

    // AUTH
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("appContent").style.display = "block";
        db.ref('users/' + user.uid).on('value', snap => {
          const val = snap.val();
          if(!val) {
             const def = { name: "Nouveau", hours:35, role:'staff', email: user.email, status: 'active' };
             db.ref('users/'+user.uid).set(def);
             currentUser = def;
          } else { currentUser = val; }
          currentUser.uid = user.uid; currentUser.email = user.email;
          updateUI();
        });
        loadData();
        renderNativeCalendar();
      } else {
        document.getElementById("loginOverlay").style.display = "flex";
        document.getElementById("appContent").style.display = "none";
      }
    });

    document.getElementById("btnLogin").onclick = () => {
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPass").value;
      auth.signInWithEmailAndPassword(email, pass).catch(e => {
          document.getElementById("loginPass").classList.add("error");
          alert("Erreur connexion : " + e.message);
      });
    };
    function clearLoginError() { document.getElementById("loginPass").classList.remove("error"); }
    function logout() { auth.signOut(); location.reload(); }
    window.resetPassword = () => {
       let e = document.getElementById("loginEmail").value;
       if(!e) e = prompt("Votre Email ?");
       if(e) auth.sendPasswordResetEmail(e).then(()=>alert("Email envoy√© !"));
    };

    function showToast(msg) {
        const t = document.getElementById("toast"); t.textContent = msg; t.className = "show";
        setTimeout(() => t.className = "", 3000);
    }

    function loadData() {
      db.ref('objectives').on('value', s => { 
          allObjs = s.val() || {}; 
          renderDashboard(); 
          if(currentUser && (currentUser.role === 'admin' || currentUser.email === SUPER_ADMIN_EMAIL)) { renderAdminObjs(); renderSimulator(); }
      });
      db.ref('users').on('value', s => { allUsers = s.val() || {}; if(currentUser && (currentUser.role==='admin'||currentUser.email===SUPER_ADMIN_EMAIL)) { renderAdminUsers(); renderSimulator(); } });
      db.ref('settings').on('value', s => { globalSettings = s.val() || { budget: 0 }; if(currentUser && (currentUser.role==='admin'||currentUser.email===SUPER_ADMIN_EMAIL)) renderSimulator(); });
      db.ref('updates').on('value', s => { allUpdates = s.val() || {}; renderUpdatesPublic(); checkNewUpdates(allUpdates); if(currentUser && currentUser.email===SUPER_ADMIN_EMAIL) renderUpdatesAdmin(); });
      if(currentUser && currentUser.email===SUPER_ADMIN_EMAIL) {
          db.ref('logs').limitToLast(100).on('value', s => { allLogs = s.val() || {}; renderLogs(allLogs); });
          db.ref('feedbacks').on('value', s => { allFeedbacks = s.val() || {}; renderFeedbacks(allFeedbacks); });
      }
    }

    function checkNewUpdates(updates) {
        const arr = Object.values(updates).sort((a,b) => b.date - a.date);
        if(arr.length === 0) return;
        const latest = arr[0];
        const lastSeen = localStorage.getItem('heiko_last_update_seen');
        const key = latest.title + latest.date;
        if(key !== lastSeen) {
            document.getElementById("topAlertText").textContent = latest.title;
            const a = document.getElementById("topAlert");
            a.classList.remove("trigger"); void a.offsetWidth; a.classList.add("trigger");
            localStorage.setItem('heiko_last_update_seen', key);
        }
    }

    function updateUI() {
      if(!currentUser) return;
      document.getElementById("userName").textContent = currentUser.name;
      document.getElementById("userHours").textContent = (currentUser.hours || 35) + "h";
      const isAdmin = (currentUser.role === 'admin' || currentUser.email === SUPER_ADMIN_EMAIL);
      document.getElementById("btnAdmin").style.display = isAdmin ? 'inline-block' : 'none';
      if(currentUser.email === SUPER_ADMIN_EMAIL) {
          document.getElementById("btnTabLogs").style.display = 'block';
          document.getElementById("btnTabFeedbacks").style.display = 'block';
          document.getElementById("superAdminBudget").style.display = 'block';
      } else {
          document.getElementById("superAdminBudget").style.display = 'none';
      }
    }

    // --- DASHBOARD RENDER ---
    function renderDashboard() {
      if(!currentUser) return;
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";
      const ratio = (currentUser.hours || 35) / BASE_HOURS;
      let totalMyGain = 0;
      let totalPotential = 0;
      
      const prims = Object.values(allObjs).filter(o => o.isPrimary && o.published);
      // Check unlock
      let primOk = true;
      if(prims.length > 0) {
        primOk = prims.every(o => {
           let win = false;
           const pct = getPct(o.current, o.target, o.isInverse);
           if(o.isFixed) {
               if(o.isNumeric) win = parseFloat(o.current) >= o.target;
               else win = pct >= 100;
           } else {
               if(o.paliers && o.paliers[0]) {
                   if(o.isNumeric) win = parseFloat(o.current) >= o.paliers[0].threshold;
                   else win = pct >= o.paliers[0].threshold;
               }
           }
           return win;
        });
      }

      // Render Primary
      if(prims.length > 0) container.innerHTML += `<div class="category-title">üî•&nbsp;<span>Priorit√© Absolue</span></div>`;
      prims.forEach(o => {
          totalPotential += getMaxPossibleGain(o) * ratio;
          container.appendChild(createCard(o, false, ratio, true));
      });

      // Render Secondary
      const secs = Object.values(allObjs).filter(o => !o.isPrimary && o.published);
      if(secs.length > 0) container.innerHTML += `<div class="category-title" style="margin-top:40px;">üíé&nbsp;<span>Bonus</span></div>`;
      secs.forEach(o => {
          totalPotential += getMaxPossibleGain(o) * ratio;
          container.appendChild(createCard(o, !primOk, ratio, false));
      });

      // Calc Gains
      Object.keys(allObjs).forEach(key => {
        const o = allObjs[key];
        if(!o.published) return;
        const pct = getPct(o.current, o.target, o.isInverse);
        const isLocked = !o.isPrimary && !primOk;
        if(!isLocked) {
             if(o.isFixed) {
                 let win = false;
                 if(o.isNumeric) win = parseFloat(o.current) >= o.target;
                 else win = pct >= 100;
                 if(win && o.paliers && o.paliers[0]) totalMyGain += (parse(o.paliers[0].prize) * ratio);
             } else {
                 if(o.paliers) o.paliers.forEach(p => { 
                     let unlocked = false;
                     if(o.isNumeric) unlocked = parseFloat(o.current) >= p.threshold;
                     else unlocked = pct >= p.threshold;
                     if(unlocked) totalMyGain += (parse(p.prize) * ratio); 
                 });
             }
        }
      });

      document.getElementById("myTotalGain").textContent = totalMyGain.toFixed(0) + "‚Ç¨";
      let fill = 0; if(totalPotential>0) fill = (totalMyGain/totalPotential)*100;
      if(fill>100) fill=100;
      document.getElementById("moneyFill").style.height = fill + "%";
      
      // Money Rain if gain > 0
      const rain = document.getElementById("moneyRain"); rain.innerHTML = "";
      if(totalMyGain > 0) {
         for(let i=0; i<15; i++) {
            const b = document.createElement("div"); b.className="bill"; b.textContent="üí∏";
            b.style.left="50%"; b.style.bottom="-50px";
            b.style.setProperty('--rx', (Math.random()-0.5)*200+"px");
            b.style.setProperty('--rx2', (Math.random()-0.5)*300+"px");
            b.style.animation = `moneyFountain ${3+Math.random()}s infinite ${Math.random()*2}s ease-in-out`;
            rain.appendChild(b);
         }
      }
      document.getElementById("lastUpdate").textContent = "MAJ: " + new Date().toLocaleDateString('fr-FR');
    }

    function createCard(obj, isLocked, userRatio, isPrimary) {
      const pct = getPct(obj.current, obj.target, obj.isInverse);
      let isWin = false;
      if(obj.isFixed) {
          if(obj.isNumeric) isWin = parseFloat(obj.current) >= obj.target;
          else isWin = pct >= 100;
      } else {
          // Si paliers, check premier palier
          if(obj.paliers && obj.paliers[0]) {
              if(obj.isNumeric) isWin = parseFloat(obj.current) >= obj.paliers[0].threshold;
              else isWin = pct >= obj.paliers[0].threshold;
          }
      }

      const el = document.createElement("div");
      let cls = "card"; if(isLocked) cls += " is-locked"; if(isWin && !isLocked) cls += " is-winner";
      el.className = cls;

      let badge = "";
      if(isLocked) badge = `<div class="status-badge badge-locked">üîí Bloqu√© par l'objectif principal</div>`;
      else if(isWin) badge = `<div class="status-badge badge-winner">üéâ Objectif Valid√©</div>`;
      else if(!isPrimary) badge = `<div class="status-badge badge-ready">üíé Bonus</div>`;

      // Middle content
      let middle = "";
      if(obj.isFixed) {
         const pz = (obj.paliers && obj.paliers[0]) ? parse(obj.paliers[0].prize) : 0;
         middle = `<div class="fixed-bonus-block ${isWin && !isLocked ? 'unlocked' : ''}"><div style="font-size:10px;text-transform:uppercase;">PRIME UNIQUE</div><div style="font-size:22px; font-weight:900;">${(pz*userRatio).toFixed(0)}‚Ç¨</div></div>`;
      } else {
         middle = `<div class="milestones">`;
         (obj.paliers||[]).forEach((p,i) => {
             let u = false;
             if(obj.isNumeric) u = parseFloat(obj.current) >= p.threshold; else u = pct >= p.threshold;
             let lbl = p.threshold + (obj.isNumeric?"":"%");
             middle += `<div class="ms-item ${u?'unlocked':''}"><div class="ms-threshold">${lbl}</div><div class="ms-circle">${u?'‚úî':(i+1)}</div><div class="ms-prize">+${(parse(p.prize)*userRatio).toFixed(0)}‚Ç¨</div></div>`;
         });
         middle += `</div>`;
      }

      let tVal = obj.hideTarget ? '???' : obj.target + (obj.isInverse && !obj.isNumeric ? '%' : '');
      let cVal = obj.hideCurrent ? '???' : obj.current + (obj.isInverse && !obj.isNumeric ? '%' : '');
      let pDisplay = pct.toFixed(0) + '%';
      if(obj.isNumeric) pDisplay = Math.floor(obj.current) + '/' + obj.target;

      const w1 = Math.min(pct, 100);
      const w2 = pct > 100 ? Math.min(pct-100, 100) : 0;

      el.innerHTML = `
        ${badge}
        <div class="card-top">
          <div style="display:flex;align-items:center;">
             <div class="obj-icon">${isPrimary?'‚ö°':'üíé'}</div>
             <div>
               <h3 style="font-weight:800; font-size:18px; line-height:1.2;">${obj.name}</h3>
               <div style="font-size:11px; color:var(--text-muted);">${isPrimary ? 'Objectif Vital' : 'Bonus'}</div>
             </div>
          </div>
        </div>
        <div class="data-boxes-row"><div class="data-box"><span class="data-box-label">Actuel</span><span class="data-box-value">${cVal}</span></div><div class="data-box"><span class="data-box-label">Objectif</span><span class="data-box-value">${tVal}</span></div></div>
        <div class="progress-track"><div class="percent-float">${pDisplay}</div><div class="progress-fill" style="width:${w1}%"></div><div class="progress-overdrive" style="width:${w2}%"></div></div>
        ${middle}`;
      return el;
    }

    // --- HELPERS IDENTIQUES V63 (Simplifi√©s pour tenir) ---
    function toggleAdmin(s) { document.getElementById("adminPanel").classList.toggle("active", s); if(s) { renderAdminUsers(); renderSimulator(); } }
    function switchTab(t) {
        document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.admin-section').forEach(s => s.parentElement.id.includes('tab') ? null : null); // Reset
        document.getElementById('btnTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
        ['team','objs','logs','feedbacks'].forEach(x => document.getElementById('tab-'+x).style.display = (x===t?'block':'none'));
    }
    function getPct(c,t,inv) {
        let cv = parseFloat(String(c).replace(',','.')); let tv = parseFloat(String(t).replace(',','.'));
        if(isNaN(cv)||isNaN(tv)) return 0;
        if(inv) { if(cv > tv) return 0; if(cv <= tv) return 100; }
        if(!tv) return 0; return (cv/tv)*100;
    }
    function parse(s) { return parseFloat(String(s).replace(/[^0-9.]/g,''))||0; }
    function getMaxPossibleGain(o) {
        if(o.isFixed && o.paliers && o.paliers[0]) return parse(o.paliers[0].prize);
        if(o.paliers) { let s=0; o.paliers.forEach(p=>s+=parse(p.prize)); return s; }
        return 0;
    }

    // --- ADMIN LOGIC (STANDARD) ---
    function renderAdminUsers() {
        const l = document.getElementById("usersList"); l.innerHTML = "";
        Object.entries(allUsers).forEach(([k, u]) => {
           const d = document.createElement("div"); d.style.padding="10px"; d.style.borderBottom="1px solid #eee";
           d.innerHTML = `<div style="display:flex;justify-content:space-between;font-weight:700;"><span>${u.name} (${u.hours}h)</span> <button onclick="openEditUser('${k}')" style="border:none;background:none;">‚úèÔ∏è</button></div><div style="font-size:10px;color:#999;">${u.email}</div>`;
           l.appendChild(d);
        });
    }
    function createUser() {
        const n=document.getElementById("nuName").value; const h=document.getElementById("nuHours").value; const e=document.getElementById("nuEmail").value;
        if(n && h && e) {
            auth.createUserWithEmailAndPassword(e, "welcome123").then(c => {
               db.ref('users/'+c.user.uid).set({ name:n, hours:h, email:e, role: document.getElementById("nuAdmin").checked?'admin':'staff' });
               showToast("Utilisateur cr√©√© !");
            }).catch(e=>alert(e.message));
        }
    }
    function openEditUser(id) {
        const u = allUsers[id];
        document.getElementById("euId").value = id; document.getElementById("euName").value = u.name;
        document.getElementById("euHours").value = u.hours; document.getElementById("euEmail").value = u.email;
        document.getElementById("euAdmin").checked = (u.role==='admin');
        document.getElementById("editUserPanel").classList.add("active");
    }
    function saveUser() {
        const id=document.getElementById("euId").value;
        db.ref('users/'+id).update({
            name: document.getElementById("euName").value,
            hours: document.getElementById("euHours").value,
            role: document.getElementById("euAdmin").checked ? 'admin':'staff'
        });
        document.getElementById("editUserPanel").classList.remove("active");
    }

    // --- OBJ ADMIN ---
    function renderAdminObjs() {
        const l = document.getElementById("objList"); l.innerHTML = "";
        Object.entries(allObjs).forEach(([k, o]) => {
            const d = document.createElement("div"); d.className="update-card";
            d.innerHTML = `<div style="font-weight:800;display:flex;justify-content:space-between;">${o.name} <button onclick="deleteObj('${k}')" style="color:red;border:none;background:none;">√ó</button></div><button class="btn" onclick="openEditObj('${k}')" style="margin-top:5px;padding:5px;font-size:10px;">Modifier</button>`;
            l.appendChild(d);
        });
    }
    function addObj() {
        const n = document.getElementById("noName").value;
        if(!n) return;
        const o = {
            name: n, target: document.getElementById("noTarget").value, current: 0,
            isPrimary: document.getElementById("noPrimary").checked,
            isInverse: document.getElementById("noInverse").checked,
            isNumeric: document.getElementById("noNumeric").checked,
            isFixed: document.getElementById("noFixed").checked,
            published: false, paliers: []
        };
        // Initial Paliers dummy
        if(o.isFixed) o.paliers.push({ threshold: 100, prize: 0 });
        else {
            [1,2,3].forEach(i => {
                const t = document.getElementById("c_p"+i+"t").value;
                if(t) o.paliers.push({ threshold: parseFloat(t), prize: 0 });
            });
        }
        db.ref('objectives').push(o);
        showToast("Objectif cr√©√© !");
    }
    function deleteObj(k) { if(confirm("Supprimer ?")) db.ref('objectives/'+k).remove(); }
    
    // --- SIMULATOR & EDIT OBJ ---
    function renderSimulator() {
        const list = document.getElementById("simObjList"); list.innerHTML = "";
        let used = 0;
        document.getElementById("simGlobalBudget").value = globalSettings.budget || 0;
        
        Object.entries(allObjs).forEach(([k, o]) => {
            const row = document.createElement("div"); row.style.marginBottom="10px"; row.style.borderBottom="1px solid #eee"; row.style.paddingBottom="5px";
            let html = `<div style="font-weight:700; font-size:12px; margin-bottom:4px;">${o.name}</div>`;
            
            if(o.paliers) {
                o.paliers.forEach((p, i) => {
                    const prizeId = `pz_${k}_${i}`;
                    const val = p.prize || 0;
                    // Calculate cost: Prize * Total FTE
                    let totalFTE = 0; Object.values(allUsers).forEach(u => totalFTE += (u.hours||0)/35);
                    const cost = val * totalFTE; 
                    used += cost;
                    
                    let label = `Palier ${p.threshold}${o.isNumeric?'':'%'}`;
                    if(o.isFixed) label = "Prime Fixe";
                    
                    html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                       <span style="font-size:10px; color:#666;">${label}</span>
                       <input type="number" id="${prizeId}" value="${val}" style="width:60px; padding:2px; font-size:11px; text-align:right;" onchange="updateLocalPrize('${k}', ${i}, this.value)">
                    </div>`;
                });
            }
            // Checkbox Publish
            html += `<div style="text-align:right; margin-top:4px;"><label style="font-size:10px;"><input type="checkbox" ${o.published?'checked':''} onchange="togglePub('${k}')"> Publi√©</label></div>`;
            row.innerHTML = html;
            list.appendChild(row);
        });

        // Gauge Logic
        const max = globalSettings.budget || 1;
        const pct = Math.min((used / max)*100, 100);
        document.getElementById("simGauge").style.width = pct + "%";
        document.getElementById("simGauge").style.backgroundColor = used > max ? "#ef4444" : "#2563eb";
        document.getElementById("simUsed").textContent = used.toFixed(0) + "‚Ç¨";
        document.getElementById("simLeft").textContent = "Reste: " + (max - used).toFixed(0) + "‚Ç¨";
        
        // Total per user 35h
        let perUser = 0;
        Object.values(allObjs).forEach(o => { if(o.published) perUser += getMaxPossibleGain(o); });
        document.getElementById("simTotalPerUser").textContent = perUser.toFixed(0) + "‚Ç¨";
    }

    function updateLocalPrize(k, idx, val) { allObjs[k].paliers[idx].prize = parseFloat(val); renderSimulator(); }
    function saveGlobalBudget() { db.ref('settings/budget').set(parseFloat(document.getElementById("simGlobalBudget").value)); showToast("Budget enregistr√©"); }
    function togglePub(k) { allObjs[k].published = !allObjs[k].published; renderSimulator(); }
    function publishSim() { db.ref('objectives').set(allObjs); showToast("üì° Configuration publi√©e !"); }

    function openEditObj(k) {
        const o = allObjs[k];
        document.getElementById("eoId").value = k; document.getElementById("eoName").value = o.name;
        document.getElementById("eoCurrent").value = o.current; document.getElementById("eoTarget").value = o.target;
        document.getElementById("eoPrimary").checked = o.isPrimary; document.getElementById("eoInverse").checked = o.isInverse;
        document.getElementById("eoNumeric").checked = o.isNumeric; document.getElementById("eoFixed").checked = o.isFixed;
        
        // Load paliers thresholds only (prizes handled in sim)
        if(o.paliers && !o.isFixed) {
            if(o.paliers[0]) document.getElementById("p1t").value = o.paliers[0].threshold;
            if(o.paliers[1]) document.getElementById("p2t").value = o.paliers[1].threshold;
            if(o.paliers[2]) document.getElementById("p3t").value = o.paliers[2].threshold;
        }
        toggleEditInputs();
        document.getElementById("editObjPanel").classList.add("active");
    }

    function saveObj() {
        const k = document.getElementById("eoId").value;
        const o = allObjs[k];
        o.name = document.getElementById("eoName").value;
        o.current = document.getElementById("eoCurrent").value;
        o.target = document.getElementById("eoTarget").value;
        o.isPrimary = document.getElementById("eoPrimary").checked;
        o.isInverse = document.getElementById("eoInverse").checked;
        o.isNumeric = document.getElementById("eoNumeric").checked;
        o.isFixed = document.getElementById("eoFixed").checked;
        
        // Update thresholds only, keep existing prizes if possible
        if(!o.isFixed) {
            const t1 = document.getElementById("p1t").value;
            const t2 = document.getElementById("p2t").value;
            const t3 = document.getElementById("p3t").value;
            if(t1) { if(!o.paliers[0]) o.paliers[0]={prize:0}; o.paliers[0].threshold = parseFloat(t1); }
            if(t2) { if(!o.paliers[1]) o.paliers[1]={prize:0}; o.paliers[1].threshold = parseFloat(t2); }
            if(t3) { if(!o.paliers[2]) o.paliers[2]={prize:0}; o.paliers[2].threshold = parseFloat(t3); }
        }
        db.ref('objectives/'+k).set(o);
        document.getElementById("editObjPanel").classList.remove("active");
    }
    function toggleCreateInputs() { document.getElementById("createTiersBlock").style.display = document.getElementById("noFixed").checked ? 'none':'block'; }
    function toggleEditInputs() { document.getElementById("editTiersBlock").style.display = document.getElementById("eoFixed").checked ? 'none':'block'; }

    // --- CALENDAR NATIVE ---
    function renderNativeCalendar() {
       const grid = document.getElementById("calGrid"); grid.innerHTML = "";
       const y = currentCalDate.getFullYear(); const m = currentCalDate.getMonth();
       const firstDay = new Date(y, m, 1).getDay(); const daysInMonth = new Date(y, m+1, 0).getDate();
       const offset = (firstDay === 0 ? 6 : firstDay - 1);
       const monthNames = ["JANVIER","F√âVRIER","MARS","AVRIL","MAI","JUIN","JUILLET","AO√õT","SEPTEMBRE","OCTOBRE","NOVEMBRE","D√âCEMBRE"];
       document.getElementById("calTitle").textContent = `${monthNames[m]} ${y}`;

       for(let i=0; i<offset; i++) grid.appendChild(document.createElement("div"));
       for(let d=1; d<=daysInMonth; d++) {
          const cell = document.createElement("div"); cell.className = "cal-cell";
          const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          
          let dots = "";
          calEvents.forEach(evt => {
             if(dStr >= evt.start && dStr <= evt.end) {
                 dots += `<span class="cal-event-dot" style="background:${evt.c}">${evt.t}</span>`;
             }
          });
          
          cell.innerHTML = `<span class="cal-date">${d}</span>${dots}`;
          grid.appendChild(cell);
       }
    }
    function prevMonth() { currentCalDate.setMonth(currentCalDate.getMonth()-1); renderNativeCalendar(); }
    function nextMonth() { currentCalDate.setMonth(currentCalDate.getMonth()+1); renderNativeCalendar(); }
    
    // UPDATES & FEEDBACK
    function sendFeedback() {
        const c = document.getElementById("fbContent").value;
        if(c) { db.ref('feedbacks').push({ user: currentUser.name, msg: c, date: Date.now() }); showToast("Message envoy√© !"); document.getElementById('feedbackModal').style.display='none'; }
    }
    function saveUpdate() {
        const t = document.getElementById("uptTitle").value; const d = document.getElementById("uptDesc").value;
        if(t && d) db.ref('updates').push({ title:t, desc:d, type: document.getElementById("uptType").value, date: Date.now() });
        showToast("Publi√©");
    }
    function renderUpdatesPublic() {
        const d = document.getElementById("publicUpdatesList"); d.innerHTML = "";
        Object.values(allUpdates).sort((a,b)=>b.date-a.date).forEach(u => {
            const c = document.createElement("div"); c.className="update-card";
            c.innerHTML = `<div style="font-weight:800;font-size:13px;margin-bottom:5px;">${u.title} <span class="update-tag tag-${u.type}">${u.type}</span></div><div style="font-size:12px;color:#555;">${u.desc}</div>`;
            d.appendChild(c);
        });
    }
    function renderUpdatesAdmin() {
        const d = document.getElementById("adminUpdatesList"); d.innerHTML = "";
        Object.keys(allUpdates).forEach(k => {
             const u = allUpdates[k];
             d.innerHTML += `<div style="font-size:11px; border-bottom:1px solid #eee; padding:5px;">${u.title} <button onclick="db.ref('updates/${k}').remove()">√ó</button></div>`;
        });
    }
    function renderFeedbacks(fbs) {
        const c = document.getElementById("feedbacksContainer"); c.innerHTML = "";
        Object.values(fbs).forEach(f => {
            c.innerHTML += `<div style="background:white; padding:10px; border-radius:10px; margin-bottom:5px; border:1px solid #eee;"><div style="font-weight:800; font-size:11px;">${f.user}</div><div style="font-size:12px;">${f.msg}</div></div>`;
        });
    }
    function renderLogs(l) {
        const c = document.getElementById("logsContainer"); c.innerHTML = "";
        Object.values(l).reverse().slice(0,50).forEach(log => {
             c.innerHTML += `<div style="font-size:10px; border-bottom:1px solid #eee; padding:4px;"><b>${log.user}</b>: ${log.action}</div>`;
        });
    }
  </script>
</body>
</html>
