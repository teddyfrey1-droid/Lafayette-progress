cat > diffusion.html <<'ENDOFFILE'
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <title>Diffusion - Lafayette</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  
  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/styles.css">
  
  <!-- Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  
  <div class="theme-toggle" onclick="toggleDarkMode()">
    <div class="theme-toggle-slider"><span class="toggle-icon"></span></div>
  </div>

  <!-- Toast -->
  <div id="toast">Action effectu√©e avec succ√®s !</div>

  <!-- Login Overlay -->
  <div id="loginOverlay">
    <h1 style="font-size: 28px; font-weight: 900; color: var(--text-main); margin-bottom: 25px; text-transform: uppercase; text-align: center; line-height: 1.4;">
      DIFFUSION<br>LAFAYETTE
    </h1>
    <div class="login-box">
      <h2 class="login-title">Connexion Membre</h2>
      <div class="input-group">
        <input type="email" id="loginEmail" placeholder="Email" oninput="clearLoginError()">
      </div>
      <div class="input-group">
        <input type="password" id="loginPass" placeholder="Mot de passe" oninput="clearLoginError()">
        <span class="toggle-password" onclick="togglePass()">üëÅ</span>
      </div>
      <button class="btn" id="btnLogin">Connexion</button>
    </div>
  </div>

  <!-- App Content -->
  <div id="appContent">
    
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="user-welcome">
        <span id="userName">--</span>
        <span class="user-badge" id="userHours">--h</span>
      </div>
      <div class="top-actions">
        <button id="btnAdmin" class="btn admin-btn" style="display:none" onclick="window.location.href='index.html#admin'">
          <span class="admin-icon" aria-hidden="true">‚öô</span>
          <span class="admin-text">Admin</span>
        </button>
        <button id="logoutBtn" onclick="logout()" class="btn logout-btn" style="width:auto; padding:8px 16px; font-size:11px; background:var(--card-bg); color:#ef4444; border:1px solid #fca5a5;">
          <span class="logout-icon" aria-hidden="true">üö™</span>
          <span class="logout-text">D√©connexion</span>
        </button>
        <button class="icon-btn" id="globalMenuBtn" onclick="toggleGlobalMenu()">‚ò∞</button>
      </div>
    </div>

    <!-- Global Menu -->
    <div class="global-menu-backdrop" id="globalMenuBackdrop" onclick="toggleGlobalMenu(false)"></div>
    <aside class="global-menu" id="globalMenu" aria-label="Menu">
      <div class="global-menu-head">
        <div class="global-menu-title">Menu</div>
        <button class="icon-btn" type="button" onclick="toggleGlobalMenu(false)" aria-label="Fermer">‚úï</button>
      </div>
      <nav class="global-menu-links">
        <a class="global-menu-link menu-dashboard" href="index.html#dashboard" onclick="toggleGlobalMenu(false)">
          <span class="menu-dashboard-label">üìä Dashboard</span>
        </a>
        <a class="global-menu-link" href="contacts.html" onclick="toggleGlobalMenu(false)">
          <span>üìá Sites & Contacts</span>
        </a>
        <a class="global-menu-link" href="diffusion.html" onclick="toggleGlobalMenu(false)" style="background:rgba(37,99,235,0.1); color:#2563eb; font-weight:700;">
          <span>üìß Diffusion</span>
        </a>
      </nav>
    </aside>

    <!-- Main Container -->
    <div class="container" style="max-width:900px;">
      
      <header style="margin-bottom:30px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
          <a href="index.html" class="btn" style="width:auto; padding:8px 16px; background:var(--border-color); color:var(--text-main);">
            ‚Üê Retour
          </a>
          <h1 style="margin:0;">üìß DIFFUSION</h1>
        </div>
        <p style="color:var(--text-muted); font-size:14px; margin:0;">
          Envoi d'emails group√©s √† ton √©quipe
        </p>
      </header>

      <!-- Admin Only Content -->
      <div id="adminOnlyContent" style="display:none;">
        
        <!-- Mail Settings -->
        <div class="admin-section">
          <h3 class="section-header-large">‚öô Configuration</h3>
          <div class="mail-settings-row">
            <div class="mail-settings-field">
              <label class="mail-label">R√©gion Firebase Functions (optionnel)</label>
              <input type="text" id="mailFunctionsRegion" placeholder="Ex: us-central1 ou europe-west1">
              <div class="mail-hint">Si ton Cloud Function est d√©ploy√©e dans une r√©gion sp√©cifique, renseigne-la ici. Sinon laisse vide.</div>
            </div>
            <div class="mail-settings-field">
              <label class="mail-label">Nom affich√© (optionnel)</label>
              <input type="text" id="mailFromName" placeholder="Ex: Heiko La Fayette">
              <div class="mail-hint">Utilis√© uniquement si ta function le supporte.</div>
            </div>
          </div>
          <div class="mail-settings-actions">
            <button class="btn" onclick="saveMailSettings()">Enregistrer</button>
          </div>
        </div>

        <!-- Quick Groups -->
        <div style="margin-top:30px;">
          <div class="mail-label" style="margin-bottom:8px;">Groupes rapides</div>
          <div id="mailQuickGroups" class="mail-quick-groups"></div>
        </div>

        <!-- Recipients -->
        <div style="margin-top:30px;">
          <div class="mail-label" style="margin-bottom:8px;">Destinataires</div>
          <div id="mailUsersGrid" class="mail-users-grid"></div>
          <div id="mailSelectedCount" class="mail-selected-count">0 destinataire(s) s√©lectionn√©(s)</div>
        </div>

        <!-- Email Form -->
        <div style="margin-top:30px;">
          <label class="mail-label">Sujet</label>
          <input type="text" id="mailSubject" placeholder="Ex: Planning de la semaine">
          
          <label class="mail-label" style="margin-top:10px;">Message</label>
          <textarea id="mailMessage" rows="8" placeholder="√âcris ton message (HTML accept√©)"></textarea>
          
          <div class="mail-actions">
            <button class="btn" onclick="sendManualEmail()">‚úâ Envoyer</button>
            <button class="btn" onclick="clearMailSelection()" style="background:#e2e8f0; color:#475569; border:1px solid #cbd5e1;">
              R√©initialiser
            </button>
          </div>
          
          <div class="mail-hint" style="margin-top:10px;">
            Pour l'envoi r√©el, il faut d√©ployer une Cloud Function. Le dossier <code>functions</code> est inclus dans ce projet.
          </div>
        </div>

        <!-- Groups Management -->
        <div class="admin-section" style="margin-top:40px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <h3 class="section-header-large" style="margin:0;">üë• Groupes mail</h3>
            <button class="btn" onclick="openMailGroupModal()" style="width:auto;">+ Nouveau groupe</button>
          </div>
          <div id="mailGroupsList" style="margin-top:12px;"></div>
        </div>

        <!-- Info Automation -->
        <div class="admin-section" style="border-left:4px solid #f59e0b; margin-top:40px;">
          <h3 class="section-header-large" style="color:#b45309;">‚ö° Automatisation pr√©par√©</h3>
          <div class="mail-hint">
            Le syst√®me est pr√™t pour des envois automatiques (ex: quand le planning change) via une Function trigger.
            Le sch√©ma du planning n'est pas d√©fini dans ce projet, donc le trigger est fourni en mod√®le dans <code>functions/index.js</code> √† adapter √† ta structure.
          </div>
        </div>

      </div>

      <!-- Non-Admin Message -->
      <div id="nonAdminMessage" style="display:none; text-align:center; padding:60px 20px; color:var(--text-muted);">
        <div style="font-size:48px; margin-bottom:20px;">üîí</div>
        <h2 style="color:var(--text-main); margin-bottom:10px;">Acc√®s Admin requis</h2>
        <p>Cette page est r√©serv√©e aux administrateurs.</p>
        <a href="index.html" class="btn" style="margin-top:20px; width:auto; padding:12px 24px;">‚Üê Retour au Dashboard</a>
      </div>

    </div>

  </div>

  <!-- Modal: Mail Group -->
  <div id="mailGroupModal" class="modal-overlay" style="display:none; z-index: 4000;">
    <div class="modal-box" style="max-width:520px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px;">
        <div>
          <div id="mailGroupModalTitle" style="font-weight:950; font-size:18px;">Groupe Mail</div>
          <div class="mail-hint">Cr√©er / modifier un groupe de destinataires.</div>
        </div>
        <button class="icon-btn" onclick="closeMailGroupModal()" aria-label="Fermer">‚úï</button>
      </div>
      
      <input type="hidden" id="mailGroupId">
      
      <label class="mail-label">Nom du groupe</label>
      <input type="text" id="mailGroupName" placeholder="Ex: √âquipe du soir">
      
      <label class="mail-label" style="margin-top:10px;">Couleur</label>
      <input type="color" id="mailGroupColor" value="#3b82f6" class="mail-color-input">
      
      <label class="mail-label" style="margin-top:12px;">Membres</label>
      <div id="mailGroupMembers" class="mail-members-list"></div>
      
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn" id="mailGroupSaveBtn" onclick="saveMailGroup()" style="flex:1;">Enregistrer</button>
        <button class="btn" onclick="closeMailGroupModal()" style="background:#e2e8f0; color:#475569; border:1px solid #cbd5e1;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="assets/js/app.js"></script>
  <script src="assets/js/email.js"></script>
  
  <script>
    // Init theme
    if(localStorage.getItem('heiko:darkmode') === null) {
      localStorage.setItem('heiko:darkmode', 'true');
    }
    if(localStorage.getItem('heiko:darkmode') === 'true') {
      document.body.classList.add('dark-mode');
    }
    window.addEventListener('DOMContentLoaded', function() {
      const icon = document.querySelector('.toggle-icon');
      if(icon) icon.textContent = document.body.classList.contains('dark-mode') ? 'üåô' : '‚òÄÔ∏è';
    });
    
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('heiko:darkmode', isDark);
      const icon = document.querySelector('.toggle-icon');
      if(icon) icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    }
    
    // Check admin access after auth
    firebase.auth().onAuthStateChanged(user => {
      if(user) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        
        firebase.database().ref('users/' + user.uid).once('value', snap => {
          const u = snap.val();
          if(u) {
            window.currentUser = u;
            window.currentUser.uid = user.uid;
            window.currentUser.email = user.email;
            
            document.getElementById('userName').textContent = u.name || 'Utilisateur';
            document.getElementById('userHours').textContent = (u.hours || 35) + 'h';
            
            const role = (u.role || '').toLowerCase();
            const isAdmin = (role === 'admin' || role === 'superadmin');
            
            if(isAdmin) {
              document.getElementById('adminOnlyContent').style.display = 'block';
              document.getElementById('nonAdminMessage').style.display = 'none';
              document.getElementById('btnAdmin').style.display = 'inline-block';
              
              // Charge les donn√©es Firebase pour le mail
              firebase.database().ref('mailGroups').on('value', (snap) => {
                window.mailGroups = snap.val() || {};
                renderDiffusionUI();
              });

              firebase.database().ref('users').on('value', (snap) => {
                window.allUsers = snap.val() || {};
                renderDiffusionUI();
              });

              firebase.database().ref('settings').on('value', (snap) => {
                window.globalSettings = snap.val() || {};
                renderDiffusionUI();
              });
              
            } else {
              document.getElementById('adminOnlyContent').style.display = 'none';
              document.getElementById('nonAdminMessage').style.display = 'block';
            }
          }
        });
      } else {
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('appContent').style.display = 'none';
      }
    });
    
    function renderDiffusionUI() {
      try {
        // Appelle les fonctions de rendu depuis email.js
        if(typeof window.renderQuickGroups === 'function') window.renderQuickGroups();
        if(typeof window.renderUsersGrid === 'function') window.renderUsersGrid();
        if(typeof window.renderGroupsList === 'function') window.renderGroupsList();
        
        // Synchronise les settings
        const reg = document.getElementById('mailFunctionsRegion');
        const fromName = document.getElementById('mailFromName');
        if(reg && window.globalSettings && window.globalSettings.functionsRegion) {
          reg.value = window.globalSettings.functionsRegion;
        }
        if(fromName && window.globalSettings && window.globalSettings.mailFromName) {
          fromName.value = window.globalSettings.mailFromName;
        }
      } catch(e) {
        console.error('Erreur rendu diffusion:', e);
      }
    }
    
    document.getElementById('btnLogin').onclick = function() {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      firebase.auth().signInWithEmailAndPassword(email, pass).catch(e => {
        document.getElementById('loginPass').classList.add('error');
        document.getElementById('loginEmail').classList.add('error');
        setTimeout(() => {
          document.getElementById('loginPass').classList.remove('error');
          document.getElementById('loginEmail').classList.remove('error');
        }, 1000);
        alert('Mot de passe incorrect !');
      });
    };
    
    function clearLoginError() {
      document.getElementById('loginPass').classList.remove('error');
      document.getElementById('loginEmail').classList.remove('error');
    }
    
    function togglePass() {
      const x = document.getElementById('loginPass');
      x.type = x.type === 'password' ? 'text' : 'password';
    }
    
    function logout() {
      firebase.auth().signOut();
      location.reload();
    }
    
    function toggleGlobalMenu(force) {
      const menu = document.getElementById('globalMenu');
      const backdrop = document.getElementById('globalMenuBackdrop');
      if(!menu || !backdrop) return;
      const isOpen = menu.classList.contains('open');
      const shouldOpen = typeof force === 'boolean' ? force : !isOpen;
      if(shouldOpen) {
        menu.classList.add('open');
        backdrop.classList.add('open');
        document.body.style.overflow = 'hidden';
      } else {
        menu.classList.remove('open');
        backdrop.classList.remove('open');
        document.body.style.overflow = '';
      }
    }
    
    document.addEventListener('keydown', e => {
      if(e.key === 'Escape') toggleGlobalMenu(false);
    });
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'show';
      setTimeout(() => { toast.className = 'hide'; }, 3000);
    }
    window.showToast = showToast;
  </script>

</body>
</html>
ENDOFFILE

echo "‚úÖ Fichier diffusion.html cr√©√© avec chargement des donn√©es !"
