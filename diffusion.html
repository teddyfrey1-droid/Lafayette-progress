<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <title>Diffusion & Alertes - Lafayette</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  
  <link rel="stylesheet" href="assets/css/styles.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
    /* --- STYLES ALERTES (INCIDENTS) --- */
    
    .alert-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-left: 5px solid #ef4444; /* Rouge par d√©faut (Urgence) */
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    /* Style quand c'est r√©solu */
    .alert-card.resolved {
      border-left-color: #10b981; /* Vert */
      background: rgba(16,185,129,0.04); /* Fond tr√®s l√©ger vert */
      opacity: 0.85;
    }

    .alert-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    
    .alert-badge { 
      font-size: 10px; font-weight: 900; text-transform: uppercase; 
      padding: 4px 8px; border-radius: 6px; 
      background: #fee2e2; color: #991b1b; 
    }
    .alert-card.resolved .alert-badge {
      background: #d1fae5; color: #065f46; /* Badge vert si r√©solu */
    }
    
    body.dark-mode .alert-badge { background: rgba(239,68,68,0.2); color: #fca5a5; }
    body.dark-mode .alert-card.resolved .alert-badge { background: rgba(16,185,129,0.2); color: #6ee7b7; }

    .alert-date { font-size: 11px; font-weight: 700; color: var(--text-muted); }
    .alert-title { font-size: 15px; font-weight: 900; color: var(--text-main); margin-bottom: 6px; line-height: 1.3; }
    .alert-snippet { font-size: 13px; color: var(--text-main); opacity: 0.8; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 15px; }

    /* FOOTER & ACTIONS */
    .alert-footer {
      margin-top: 10px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    /* GROS BOUTON D'ACTION */
    .btn-resolve {
      background: #10b981;
      color: white;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 800;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(16,185,129,0.3);
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.1s;
    }
    .btn-resolve:active { transform: scale(0.98); }
    .btn-resolve span { font-size: 18px; }

    /* INFO R√âSOLUTION */
    .resolved-info {
      text-align: center;
      color: #059669;
      font-weight: 800;
      font-size: 12px;
      display: flex; flex-direction: column; gap: 4px;
      padding: 5px;
    }
    .resolved-by { font-size: 14px; font-weight: 900; }
    
    .alert-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); font-style: italic; }
  </style>
</head>
<body>
  
  <div class="theme-toggle" onclick="toggleDarkMode()">
    <div class="theme-toggle-slider"><span class="toggle-icon"></span></div>
  </div>

  <div id="toast">Action effectu√©e avec succ√®s !</div>

  <div id="loginOverlay">
    <h1 style="font-size: 28px; font-weight: 900; color: var(--text-main); margin-bottom: 25px; text-transform: uppercase; text-align: center; line-height: 1.4;">
      DIFFUSION<br>& ALERTES
    </h1>
    <div class="login-box">
      <h2 class="login-title">Connexion Membre</h2>
      <div class="input-group">
        <input type="email" id="loginEmail" placeholder="Email" oninput="clearLoginError()">
      </div>
      <div class="input-group">
        <input type="password" id="loginPass" placeholder="Mot de passe" oninput="clearLoginError()">
        <span class="toggle-password" onclick="togglePass()">üëÅ</span>
      </div>
      <button class="btn" id="btnLogin">Connexion</button>
    </div>
  </div>

  <div id="appContent">
    
    <div class="top-bar">
      <div class="user-welcome">
        <span id="userName">--</span>
        <span class="user-badge" id="userHours">--h</span>
      </div>
      <div class="top-actions">
        <button id="btnAdmin" class="btn admin-btn" style="display:none" onclick="window.location.href='index.html#admin'">
          <span class="admin-icon" aria-hidden="true">‚öô</span>
          <span class="admin-text">Admin</span>
        </button>
        <button id="logoutBtn" onclick="logout()" class="btn logout-btn" style="width:auto; padding:8px 16px; font-size:11px; background:var(--card-bg); color:#ef4444; border:1px solid #fca5a5;">
          <span class="logout-icon" aria-hidden="true">üö™</span>
          <span class="logout-text">D√©connexion</span>
        </button>
        <button class="icon-btn" id="globalMenuBtn" onclick="toggleGlobalMenu()">‚ò∞</button>
      </div>
    </div>

    <div class="global-menu-backdrop" id="globalMenuBackdrop" onclick="toggleGlobalMenu(false)"></div>
    <aside class="global-menu" id="globalMenu" aria-label="Menu">
      <div class="global-menu-head">
        <div class="global-menu-title">Menu</div>
        <button class="icon-btn" type="button" onclick="toggleGlobalMenu(false)" aria-label="Fermer">‚úï</button>
      </div>
      <nav class="global-menu-links">
        <a class="global-menu-link menu-dashboard" href="index.html#dashboard" onclick="toggleGlobalMenu(false)">
          <span class="menu-dashboard-label">üìä Dashboard</span>
        </a>
        <a class="global-menu-link" href="contacts.html" onclick="toggleGlobalMenu(false)">
          <span>üìá Sites & Contacts</span>
        </a>
        <a class="global-menu-link" href="diffusion.html" onclick="toggleGlobalMenu(false)" style="background:rgba(37,99,235,0.1); color:#2563eb; font-weight:700;">
          <span>üìß Diffusion / Alertes</span>
        </a>
      </nav>
    </aside>

    <div class="container" style="max-width:900px;">
      
      <header style="margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
          <a href="index.html" class="btn" style="width:auto; padding:8px 16px; background:var(--border-color); color:var(--text-main);">
            ‚Üê Retour
          </a>
          <h1 style="margin:0;">üì¢ COMMUNICATION</h1>
        </div>
      </header>

      <div class="dir-tabs" role="tablist" style="margin-bottom:25px;">
        <button class="dir-tab active" id="tabBtnDiffusion" onclick="switchTab('diffusion')">üìß Diffusion</button>
        <button class="dir-tab" id="tabBtnAlerts" onclick="switchTab('alerts')">‚ö†Ô∏è Historique Alertes</button>
      </div>

      <section id="panelDiffusion">
        <div id="adminOnlyContent" style="display:none;">
          <div class="admin-section">
            <h3 class="section-header-large">‚öô Configuration</h3>
            <div class="mail-settings-row">
              <div class="mail-settings-field">
                <label class="mail-label">R√©gion Functions</label>
                <input type="text" id="mailFunctionsRegion" placeholder="Ex: us-central1">
              </div>
              <div class="mail-settings-field">
                <label class="mail-label">Nom affich√©</label>
                <input type="text" id="mailFromName" placeholder="Ex: Heiko La Fayette">
              </div>
            </div>
            <div class="mail-settings-actions">
              <button class="btn" onclick="saveMailSettings()">Enregistrer</button>
            </div>
          </div>

          <div style="margin-top:30px;">
            <div class="mail-label" style="margin-bottom:8px;">Groupes rapides</div>
            <div id="mailQuickGroups" class="mail-quick-groups"></div>
          </div>

          <div style="margin-top:30px;">
            <div class="mail-label" style="margin-bottom:8px;">Destinataires</div>
            <div id="mailUsersGrid" class="mail-users-grid"></div>
            <div id="mailSelectedCount" class="mail-selected-count">0 destinataire(s) s√©lectionn√©(s)</div>
          </div>

          <div style="margin-top:30px;">
            <label class="mail-label">Sujet</label>
            <input type="text" id="mailSubject" placeholder="Ex: Planning de la semaine">
            
            <label class="mail-label" style="margin-top:10px;">Message</label>
            <textarea id="mailMessage" rows="8" placeholder="√âcris ton message (HTML accept√©)"></textarea>
            
            <div class="mail-actions">
              <button class="btn" onclick="sendManualEmail()">‚úâ Envoyer</button>
              <button class="btn" onclick="clearMailSelection()" style="background:#e2e8f0; color:#475569; border:1px solid #cbd5e1;">R√©initialiser</button>
            </div>
          </div>

          <div class="admin-section" style="margin-top:40px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <h3 class="section-header-large" style="margin:0;">üë• Groupes mail</h3>
              <button class="btn" onclick="openMailGroupModal()" style="width:auto;">+ Nouveau groupe</button>
            </div>
            <div id="mailGroupsList" style="margin-top:12px;"></div>
          </div>
        </div>

        <div id="nonAdminMessage" style="display:none; text-align:center; padding:60px 20px; color:var(--text-muted);">
          <div style="font-size:48px; margin-bottom:20px;">üîí</div>
          <h2 style="color:var(--text-main); margin-bottom:10px;">Acc√®s Diffusion restreint</h2>
          <p>Seuls les administrateurs peuvent envoyer des messages.</p>
        </div>
      </section>

     <section id="panelAlerts" style="display:none;">
         <div class="admin-section" style="border-left:4px solid #ef4444; background: rgba(254,226,226,0.1);">
            <div style="display:flex; gap:15px; align-items:center;">
               <div style="font-size:24px;">üö®</div>
               <div style="flex:1;">
                 <h3 style="margin:0; font-size:16px; color:#b91c1c;">Surveillance Automatique</h3>
                 <p style="margin:4px 0 0 0; font-size:13px; color:#7f1d1d;">Connect√© √† EatPilot. Les alertes critiques (froid, technique) apparaissent ici en temps r√©el.</p>
               </div>
            </div>
            <div style="margin-top:15px; text-align:right;">
               <button class="btn" onclick="simulateAlert()" style="width:auto; font-size:11px; padding:6px 12px; background:#71717a; border:none;">
                 üß™ Simuler une alerte
               </button>
            </div>
         </div>
         
         <div id="alertsList" style="margin-top:20px;">
            <div class="alert-empty">Chargement...</div>
         </div>
      </section>
         
         <div id="alertsList" style="margin-top:20px;">
            <div class="alert-empty">Chargement...</div>
         </div>
      </section>

    </div>
  </div>

  <div id="mailGroupModal" class="modal-overlay" style="display:none; z-index: 4000;">
    <div class="modal-box" style="max-width:520px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px;">
        <div>
          <div id="mailGroupModalTitle" style="font-weight:950; font-size:18px;">Groupe Mail</div>
        </div>
        <button class="icon-btn" onclick="closeMailGroupModal()" aria-label="Fermer">‚úï</button>
      </div>
      <input type="hidden" id="mailGroupId">
      <label class="mail-label">Nom du groupe</label>
      <input type="text" id="mailGroupName" placeholder="Ex: √âquipe du soir">
      <label class="mail-label" style="margin-top:10px;">Couleur</label>
      <input type="color" id="mailGroupColor" value="#3b82f6" class="mail-color-input">
      <label class="mail-label" style="margin-top:12px;">Membres</label>
      <div id="mailGroupMembers" class="mail-members-list"></div>
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn" id="mailGroupSaveBtn" onclick="saveMailGroup()" style="flex:1;">Enregistrer</button>
        <button class="btn" onclick="closeMailGroupModal()" style="background:#e2e8f0; color:#475569; border:1px solid #cbd5e1;">Annuler</button>
      </div>
    </div>
  </div>

  <script src="assets/js/app.js"></script>
  <script src="assets/js/email.js"></script>
  
<script>
    // --- 1. CONFIGURATION & OUTILS ---
    if(localStorage.getItem('heiko_dark_mode') === 'true') document.body.classList.add('dark-mode');
    
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('heiko_dark_mode', document.body.classList.contains('dark-mode'));
      const icon = document.querySelector('.toggle-icon'); 
      if(icon) icon.textContent = document.body.classList.contains('dark-mode') ? 'üåô' : '‚òÄÔ∏è';
    }

    function showToast(m) { 
        const t=document.getElementById('toast'); 
        if(t){ t.textContent=m; t.className='show'; setTimeout(()=>t.className='hide',3000); }
    }
    window.showToast = showToast;

    // --- 2. AUTHENTIFICATION ---
    firebase.auth().onAuthStateChanged(user => {
      if(user) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        
        firebase.database().ref('users/' + user.uid).once('value', snap => {
          const u = snap.val();
          if(u) {
            window.currentUser = u;
            window.currentUser.uid = user.uid;
            
            document.getElementById('userName').textContent = u.name || 'Membre';
            const hours = u.hours || 35;
            document.getElementById('userHours').textContent = hours + 'h';
            
            const isAdmin = (u.role === 'admin' || u.role === 'superadmin');
            
            if(isAdmin) {
              document.getElementById('adminOnlyContent').style.display = 'block';
              document.getElementById('nonAdminMessage').style.display = 'none';
              document.getElementById('btnAdmin').style.display = 'inline-block';
              
              // Chargement donn√©es mail (Admin seulement)
              firebase.database().ref('mailGroups').on('value', s => { window.mailGroups = s.val() || {}; renderDiffusionUI(); });
              firebase.database().ref('users').on('value', s => { window.allUsers = s.val() || {}; renderDiffusionUI(); });
              firebase.database().ref('settings').on('value', s => { window.globalSettings = s.val() || {}; renderDiffusionUI(); });

            } else {
              document.getElementById('adminOnlyContent').style.display = 'none';
              document.getElementById('nonAdminMessage').style.display = 'block';
            }
          }
        });
        
        // Charger les alertes d√®s qu'on est connect√©
        loadAlertsData();

      } else {
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('appContent').style.display = 'none';
      }
    });

    document.getElementById('btnLogin').onclick = function() {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      firebase.auth().signInWithEmailAndPassword(email, pass).catch(() => alert('Erreur mot de passe'));
    };

    window.logout = function() { firebase.auth().signOut(); location.reload(); }
    window.togglePass = function() { const x = document.getElementById('loginPass'); x.type = x.type==='password'?'text':'password'; }
    window.clearLoginError = function() {} 

    // --- 3. GESTION ONGLETS ---
    window.switchTab = function(tabName) {
      document.getElementById('tabBtnDiffusion').classList.toggle('active', tabName === 'diffusion');
      document.getElementById('tabBtnAlerts').classList.toggle('active', tabName === 'alerts');
      document.getElementById('panelDiffusion').style.display = (tabName === 'diffusion') ? 'block' : 'none';
      document.getElementById('panelAlerts').style.display = (tabName === 'alerts') ? 'block' : 'none';
    }

    // Init Onglets
    if(window.location.hash === '#alerts') switchTab('alerts'); else switchTab('diffusion');


    // --- 4. LOGIQUE ALERTES (INCIDENTS) ---
    function loadAlertsData() {
      const container = document.getElementById('alertsList');
      if(!container) return;

      firebase.database().ref('alerts').orderByChild('date').limitToLast(50).on('value', (snap) => {
        const data = snap.val();
        container.innerHTML = "";
        
        if(!data) {
          container.innerHTML = `<div class="alert-empty">Aucun incident enregistr√©.</div>`;
          return;
        }

        const list = Object.keys(data).map(k => ({id: k, ...data[k]})).sort((a,b) => b.date - a.date);

        list.forEach(item => {
          const d = new Date(item.date);
          const dateStr = d.toLocaleDateString('fr-FR', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' });
          const cleanBody = (item.body || '').replace(/<[^>]+>/g, ' ').substring(0, 200);

          const isResolved = !!item.resolvedBy;
          
          let footerHtml = '';
          let cardClass = 'alert-card';
          let badgeText = item.source || 'INCIDENT';

          if (isResolved) {
             cardClass += ' resolved';
             badgeText = 'R√âSOLU';
             const resolverName = item.resolvedByName || 'Un membre';
             const resolvedTime = item.resolvedAt ? new Date(item.resolvedAt).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) : '';
             
             footerHtml = `
               <div class="resolved-info">
                 <div class="resolved-by">‚úÖ R√©gl√© par ${escapeHtml(resolverName)}</div>
                 <div style="font-size:11px; opacity:0.8;">√† ${resolvedTime}</div>
               </div>
             `;
          } else {
             footerHtml = `
               <button class="btn-resolve" onclick="solveIssue('${item.id}')">
                 <span>‚úÖ</span> J'ai r√©gl√© le probl√®me
               </button>
             `;
          }

          const card = document.createElement('div');
          card.className = cardClass;
          card.innerHTML = `
            <div class="alert-header">
               <span class="alert-badge">${badgeText}</span>
               <span class="alert-date">${dateStr}</span>
            </div>
            <div class="alert-title">${escapeHtml(item.title)}</div>
            <div class="alert-snippet">${escapeHtml(cleanBody)}</div>
            <div class="alert-footer">
               ${footerHtml}
            </div>
          `;
          container.appendChild(card);
        });
      });
    }

    window.solveIssue = function(alertId) {
      if(!window.currentUser) return alert("Erreur: Tu dois √™tre connect√©.");
      const name = window.currentUser.name || "√âquipe";
      if(confirm("Confirmes-tu avoir r√©gl√© ce probl√®me ?")) {
        firebase.database().ref(`alerts/${alertId}`).update({
          resolvedBy: window.currentUser.uid,
          resolvedByName: name,
          resolvedAt: Date.now()
        }).then(() => {
          showToast("‚úÖ Incident clos !");
        }).catch(e => {
          alert("Erreur: " + e.message);
        });
      }
    }

    // --- 5. FONCTION DE SIMULATION (CORRIG√âE) ---
    window.simulateAlert = function() {
      console.log("Tentative de simulation...");
      if(!firebase.apps.length) return alert("Erreur: Firebase non connect√©");
      
      if(!confirm("Cr√©er une fausse alerte pour tester l'affichage ?")) return;
      
      const fakeIssues = [
        "Temp√©rature Frigo Positif (+12¬∞C)",
        "Coupure Courant Zone Cuisine",
        "Sonde Cong√©lateur HS",
        "Porte Chambre Froide Ouverte"
      ];
      const randomIssue = fakeIssues[Math.floor(Math.random() * fakeIssues.length)];

      firebase.database().ref('alerts').push({
        title: "TEST: " + randomIssue,
        body: "Ceci est une simulation pour v√©rifier le syst√®me. Aucune action requise.",
        date: Date.now(),
        source: "SIMULATION"
      }).then(() => {
        showToast("üß™ Alerte de test envoy√©e !");
      }).catch(err => {
        alert("Erreur: " + err.message);
        console.error(err);
      });
    }

    // Helpers
    function escapeHtml(text) {
      if (!text) return text;
      return String(text).replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
      });
    }

    function renderDiffusionUI() {
      if(typeof window.renderQuickGroups === 'function') window.renderQuickGroups();
      if(typeof window.renderUsersGrid === 'function') window.renderUsersGrid();
      if(typeof window.renderGroupsList === 'function') window.renderGroupsList();
      
      const reg = document.getElementById('mailFunctionsRegion');
      const fromName = document.getElementById('mailFromName');
      if(reg && window.globalSettings?.functionsRegion) reg.value = window.globalSettings.functionsRegion;
      if(fromName && window.globalSettings?.mailFromName) fromName.value = window.globalSettings.mailFromName;
    }
    
    window.toggleGlobalMenu = function(force) {
      const menu = document.getElementById('globalMenu');
      const backdrop = document.getElementById('globalMenuBackdrop');
      if(!menu || !backdrop) return;
      const isOpen = menu.classList.contains('open');
      const shouldOpen = typeof force === 'boolean' ? force : !isOpen;
      if(shouldOpen) { menu.classList.add('open'); backdrop.classList.add('open'); }
      else { menu.classList.remove('open'); backdrop.classList.remove('open'); }
    }
  </script>
</body>
</html>
