<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <title>Diffusion & Alertes - Lafayette</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  
  <link rel="stylesheet" href="assets/css/styles.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* Styles sp√©cifiques pour les cartes d'alerte */
    .alert-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-left: 4px solid #ef4444;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }
    .alert-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .alert-badge { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 4px 8px; border-radius: 6px; background: #fee2e2; color: #991b1b; }
    body.dark-mode .alert-badge { background: rgba(239,68,68,0.2); color: #fca5a5; }
    .alert-date { font-size: 11px; font-weight: 700; color: var(--text-muted); }
    .alert-title { font-size: 15px; font-weight: 900; color: var(--text-main); margin-bottom: 6px; line-height: 1.3; }
    .alert-snippet { font-size: 13px; color: var(--text-main); opacity: 0.8; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .alert-routing-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(148,163,184,0.10);
      font-size: 11px;
      font-weight: 900;
      color: var(--text-muted);
    }
    body.dark-mode .alert-routing-chip{ border-color: rgba(148,163,184,0.16); background: rgba(148,163,184,0.10); }
    .alert-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); font-style: italic; }
  </style>
</head>
<body>
  
  <div class="theme-toggle" onclick="toggleDarkMode()">
    <div class="theme-toggle-slider"><span class="toggle-icon"></span></div>
  </div>

  <div id="toast">Action effectu√©e avec succ√®s !</div>

  <div id="loginOverlay">
    
    <div class="pulse-login-brand"><span class="pulse-logo-inline pulse-logo-login" aria-label="Pulse"><svg width="140" height="32" viewBox="0 0 140 32" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Pulse">
  <defs>
    <linearGradient id="pulseGrad_login_diff" x1="0" y1="0" x2="34" y2="0" gradientUnits="userSpaceOnUse">
      <stop stop-color="#D10FA8"/>
      <stop offset="1" stop-color="#7A2FF0"/>
    </linearGradient>
  </defs>
  <path d="M4 16H11.5L15.5 9.5L19.5 23L23.5 16H34"
        stroke="url(#pulseGrad_login_diff)" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
  <text x="44" y="22" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
        font-size="18" font-weight="600" fill="currentColor">Pulse</text>
</svg></span></div>
<h1 style="font-size: 28px; font-weight: 900; color: var(--text-main); margin-bottom: 25px; text-transform: uppercase; text-align: center; line-height: 1.4;">
      DIFFUSION<br>& ALERTES
    </h1>
    <div class="login-box">
      <h2 class="login-title">Connexion Membre</h2>
      <div class="input-group">
        <input type="email" id="loginEmail" placeholder="Email" oninput="clearLoginError()">
      </div>
      <div class="input-group">
        <input type="password" id="loginPass" placeholder="Mot de passe" oninput="clearLoginError()">
        <span class="toggle-password" onclick="togglePass()">üëÅ</span>
      </div>
      <button class="btn" id="btnLogin">Connexion</button>
    </div>
  </div>

  <div id="appContent">
    
    <div class="top-bar">
      <div class="user-welcome">
        <span id="userName">--</span>
        <span class="user-badge" id="userHours">--h</span>
      </div>
      <div class="top-actions">
        <button id="btnAdmin" class="btn admin-btn" style="display:none" onclick="window.location.href='index.html#admin'">
          <span class="admin-icon" aria-hidden="true">‚öô</span>
          <span class="admin-text">Admin</span>
        </button>
        <button id="logoutBtn" onclick="logout()" class="btn logout-btn" style="width:auto; padding:8px 16px; font-size:11px; background:var(--card-bg); color:#ef4444; border:1px solid #fca5a5;">
          <span class="logout-icon" aria-hidden="true">üö™</span>
          <span class="logout-text">D√©connexion</span>
        </button>
        <button class="icon-btn" id="globalMenuBtn" onclick="toggleGlobalMenu()">‚ò∞</button>
      </div>
    </div>

    <div class="global-menu-backdrop" id="globalMenuBackdrop" onclick="toggleGlobalMenu(false)"></div>
    <aside class="global-menu" id="globalMenu" aria-label="Menu">
      <div class="global-menu-head">
        <div class="global-menu-title">Menu</div>
        <button class="icon-btn" type="button" onclick="toggleGlobalMenu(false)" aria-label="Fermer">‚úï</button>
      </div>
      <nav class="global-menu-links">
        <a class="global-menu-link menu-dashboard" href="index.html#dashboard" onclick="toggleGlobalMenu(false)">
          <span class="menu-dashboard-label">üìä Dashboard</span>
        </a>
        <a class="global-menu-link" href="contacts.html" onclick="toggleGlobalMenu(false)">
          <span>üìá Sites & Contacts</span>
        </a>
        <a class="global-menu-link" href="diffusion.html" onclick="toggleGlobalMenu(false)" style="background:rgba(37,99,235,0.1); color:#2563eb; font-weight:700;">
          <span>üìß Diffusion / Alertes</span>
        </a>
      </nav>
    </aside>

    <div class="container" style="max-width:900px;">
      
      <header style="margin-bottom:20px;">
        <div class="page-head-row diffusion-head" style="margin-bottom:15px;">
          <a href="index.html" class="pulse-logo-inline pulse-logo-page" aria-label="Pulse"><svg width="140" height="32" viewBox="0 0 140 32" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Pulse">
  <defs>
    <linearGradient id="pulseGrad_top_diff" x1="0" y1="0" x2="34" y2="0" gradientUnits="userSpaceOnUse">
      <stop stop-color="#D10FA8"/>
      <stop offset="1" stop-color="#7A2FF0"/>
    </linearGradient>
  </defs>
  <path d="M4 16H11.5L15.5 9.5L19.5 23L23.5 16H34"
        stroke="url(#pulseGrad_top_diff)" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
  <text x="44" y="22" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
        font-size="18" font-weight="600" fill="currentColor">Pulse</text>
</svg></a>
          <a href="index.html" class="btn btn-back" style="width:auto; padding:8px 16px; background:var(--border-color); color:var(--text-main);">
            ‚Üê Retour
          </a>
          <h1 class="page-head-title diffusion-title">üì¢ COMMUNICATION</h1>
          <span class="page-head-spacer" aria-hidden="true"></span>
        </div>
      </header>

      <div class="dir-tabs" role="tablist" style="margin-bottom:25px;">
        <button class="dir-tab active" id="tabBtnDiffusion" onclick="switchTab('diffusion')">üìß Diffusion</button>
        <button class="dir-tab" id="tabBtnAlerts" onclick="switchTab('alerts')">‚ö†Ô∏è Historique Alertes</button>
      </div>

      <section id="panelDiffusion">
        <div id="adminOnlyContent" style="display:none;">
          <div class="admin-section">
            <h3 class="section-header-large">‚öô Configuration</h3>
            <div class="mail-settings-row">
              <div class="mail-settings-field">
                <label class="mail-label">R√©gion Functions</label>
                <input type="text" id="mailFunctionsRegion" placeholder="Ex: us-central1">
              </div>
              <div class="mail-settings-field">
                <label class="mail-label">Nom affich√©</label>
                <input type="text" id="mailFromName" placeholder="Ex: Heiko La Fayette">
              </div>
            </div>
            <div class="mail-settings-actions">
              <button class="btn" onclick="saveMailSettings()">Enregistrer</button>
            </div>
          </div>

          <div style="margin-top:30px;">
            <div class="mail-label" style="margin-bottom:8px;">Groupes rapides</div>
            <div id="mailQuickGroups" class="mail-quick-groups"></div>
          </div>

          <div style="margin-top:30px;">
            <div class="mail-label" style="margin-bottom:8px;">Destinataires</div>
            <div id="mailUsersGrid" class="mail-users-grid"></div>
            <div id="mailSelectedCount" class="mail-selected-count">0 destinataire(s) s√©lectionn√©(s)</div>
          </div>

          <div style="margin-top:30px;">
            <label class="mail-label">Sujet</label>
            <input type="text" id="mailSubject" placeholder="Ex: Planning de la semaine">
            
            <label class="mail-label" style="margin-top:10px;">Message</label>
            <textarea id="mailMessage" rows="8" placeholder="√âcris ton message (HTML accept√©)"></textarea>
            
            <div class="mail-actions">
              <button class="btn" onclick="sendManualEmail()">‚úâ Envoyer</button>
              <button class="btn" onclick="clearMailSelection()" style="background:#e2e8f0; color:#475569; border:1px solid #cbd5e1;">R√©initialiser</button>
            </div>
          </div>

          <div class="admin-section" style="margin-top:40px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <h3 class="section-header-large" style="margin:0;">üë• Groupes mail</h3>
              <button class="btn" onclick="openMailGroupModal()" style="width:auto;">+ Nouveau groupe</button>
            </div>
            <div id="mailGroupsList" style="margin-top:12px;"></div>
          </div>
        </div>

        <div id="nonAdminMessage" style="display:none; text-align:center; padding:60px 20px; color:var(--text-muted);">
          <div style="font-size:48px; margin-bottom:20px;">üîí</div>
          <h2 style="color:var(--text-main); margin-bottom:10px;">Acc√®s Diffusion restreint</h2>
          <p>Seuls les administrateurs peuvent envoyer des messages.</p>
        </div>
      </section>

      <section id="panelAlerts" style="display:none;">
         <div class="admin-section" style="border-left:4px solid #ef4444; background: rgba(254,226,226,0.1);">
            <div style="display:flex; gap:15px; align-items:center;">
               <div style="font-size:24px;">üö®</div>
               <div>
                 <h3 style="margin:0; font-size:16px; color:#b91c1c;">Surveillance Automatique</h3>
                 <p style="margin:4px 0 0 0; font-size:13px; color:#7f1d1d;">Connect√© √† EatPilot. Les alertes critiques (froid, technique) apparaissent ici en temps r√©el.</p>
               </div>
            </div>
         </div>

         <!-- Admin: Routage des alertes (√©quipes programm√©es + canaux) -->
         <div id="alertRoutingAdmin" class="admin-section" style="margin-top:14px; display:none;">
           <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
             <div style="min-width:220px;">
               <h3 style="margin:0; font-size:16px;">‚è±Ô∏è Routage des alertes</h3>
               <p style="margin:6px 0 0 0; font-size:13px; opacity:0.85;">Heure France (Europe/Paris). Les chevauchements sont autoris√©s : si 2 √©quipes couvrent la m√™me heure, les 2 re√ßoivent l'alerte.</p>
             </div>
             <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
               <div class="field">
                 <label style="font-size:12px; opacity:0.8;">Canal</label>
                 <select id="alertRoutingMode" class="input" style="min-width:240px;">
                   <option value="push_fallback">üîî Push + üìß Email si Push OFF</option>
                   <option value="both">üîî Push + üìß Email (√† tous)</option>
                   <option value="push_only">üîî Push uniquement</option>
                 </select>
               </div>
               <div class="field">
                 <label style="font-size:12px; opacity:0.8;">Si aucune √©quipe active</label>
                 <select id="alertRoutingFallbackNoTeam" class="input" style="min-width:190px;">
                   <option value="all">Pr√©venir tout le monde</option>
                   <option value="admins">Admins seulement</option>
                   <option value="none">Personne</option>
                 </select>
               </div>
               <button class="btn" id="btnSaveAlertRouting" onclick="saveAlertRoutingSettings()" style="white-space:nowrap;">üíæ Sauver</button>
             </div>
           </div>

           <div style="margin-top:14px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
             <div style="font-weight:800;">√âquipes programm√©es</div>
             <button class="btn" onclick="openAlertTeamModal(null)" style="white-space:nowrap;">‚ûï Nouvelle √©quipe</button>
           </div>

           <div id="alertTeamsList" class="alert-teams-list" style="margin-top:12px;"></div>
         </div>
         
         <div id="alertsList" style="margin-top:20px;">
            <div class="alert-empty">Chargement...</div>
         </div>
      </section>

    </div>
  </div>

  <div id="mailGroupModal" class="modal-overlay" style="display:none; z-index: 4000;">
    <div class="modal-box" style="max-width:520px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px;">
        <div>
          <div id="mailGroupModalTitle" style="font-weight:950; font-size:18px;">Groupe Mail</div>
        </div>
        <button class="icon-btn" onclick="closeMailGroupModal()" aria-label="Fermer">‚úï</button>
      </div>
      <input type="hidden" id="mailGroupId">
      <label class="mail-label">Nom du groupe</label>
      <input type="text" id="mailGroupName" placeholder="Ex: √âquipe du soir">
      <label class="mail-label" style="margin-top:10px;">Couleur</label>
      <input type="color" id="mailGroupColor" value="#3b82f6" class="mail-color-input">
      <label class="mail-label" style="margin-top:12px;">Membres</label>
      <div id="mailGroupMembers" class="mail-members-list"></div>
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn" id="mailGroupSaveBtn" onclick="saveMailGroup()" style="flex:1;">Enregistrer</button>
        <button class="btn" onclick="closeMailGroupModal()" style="background:#e2e8f0; color:#475569; border:1px solid #cbd5e1;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Modal: √âquipe programm√©e (alertTeams) -->
  <div id="alertTeamModal" class="modal-overlay" style="display:none; z-index: 4100;">
    <div class="modal-box" style="max-width:560px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px;">
        <div>
          <div id="alertTeamModalTitle" style="font-weight:950; font-size:18px;">√âquipe programm√©e</div>
          <div style="font-size:12px; opacity:0.75; margin-top:2px;">Heure France (Europe/Paris). Chevauchements autoris√©s.</div>
        </div>
        <button class="icon-btn" onclick="closeAlertTeamModal()" aria-label="Fermer">‚úï</button>
      </div>
      <input type="hidden" id="alertTeamId">

      <div style="display:grid; grid-template-columns: 1fr 120px; gap:10px;">
        <div>
          <label class="mail-label">Nom de l'√©quipe</label>
          <input type="text" id="alertTeamName" placeholder="Ex: √âquipe du matin">
        </div>
        <div>
          <label class="mail-label">Couleur</label>
          <input type="color" id="alertTeamColor" value="#8b5cf6" class="mail-color-input">
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div>
          <label class="mail-label">D√©but</label>
          <input type="time" id="alertTeamStart" value="09:00" class="input">
        </div>
        <div>
          <label class="mail-label">Fin</label>
          <input type="time" id="alertTeamEnd" value="18:00" class="input">
        </div>
      </div>

      <label class="mail-label" style="margin-top:12px;">Jours actifs</label>
      <div id="alertTeamDays" class="days-chips" style="display:flex; gap:8px; flex-wrap:wrap;">
        <label class="day-chip"><input type="checkbox" value="1" checked> Lun</label>
        <label class="day-chip"><input type="checkbox" value="2" checked> Mar</label>
        <label class="day-chip"><input type="checkbox" value="3" checked> Mer</label>
        <label class="day-chip"><input type="checkbox" value="4" checked> Jeu</label>
        <label class="day-chip"><input type="checkbox" value="5" checked> Ven</label>
        <label class="day-chip"><input type="checkbox" value="6"> Sam</label>
        <label class="day-chip"><input type="checkbox" value="7"> Dim</label>
      </div>

      <label class="mail-label" style="margin-top:12px;">Membres</label>
      <input type="text" id="alertTeamMemberSearch" class="input" placeholder="Rechercher un membre..." oninput="renderAlertTeamModalMembers()" style="margin-bottom:10px;">
      <div id="alertTeamMembers" class="mail-members-list"></div>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn" onclick="saveAlertTeam()" style="flex:1;">Enregistrer</button>
        <button class="btn" onclick="closeAlertTeamModal()" style="background:#e2e8f0; color:#475569; border:1px solid #cbd5e1;">Annuler</button>
      </div>
    </div>
  </div>

  <script src="assets/js/app.js"></script>
  <script src="assets/js/email.js"></script>
  
  <script>
    // --- GESTION DES ONGLETS & ALERTES ---
    
    // Initialisation
    window.addEventListener('DOMContentLoaded', () => {
      // V√©rifie si on arrive avec #alerts dans l'URL
      if(window.location.hash === '#alerts') {
        switchTab('alerts');
      } else {
        switchTab('diffusion');
      }
      
      // Charge les alertes en temps r√©el
      loadAlertsData();
    });

    function switchTab(tabName) {
      // Boutons
      document.getElementById('tabBtnDiffusion').classList.toggle('active', tabName === 'diffusion');
      document.getElementById('tabBtnAlerts').classList.toggle('active', tabName === 'alerts');
      
      // Panneaux
      document.getElementById('panelDiffusion').style.display = (tabName === 'diffusion') ? 'block' : 'none';
      document.getElementById('panelAlerts').style.display = (tabName === 'alerts') ? 'block' : 'none';
      
      // Update URL hash sans scroll
      history.replaceState(null, null, tabName === 'alerts' ? '#alerts' : '#diffusion');
    }

    function loadAlertsData() {
      const container = document.getElementById('alertsList');
      // On √©coute Firebase : alerts (limitToLast 50)
      firebase.database().ref('alerts').orderByChild('date').limitToLast(50).on('value', (snap) => {
        const data = snap.val();
        container.innerHTML = "";
        
        if(!data) {
          container.innerHTML = `<div class="alert-empty">Aucune alerte enregistr√©e.</div>`;
          return;
        }

        // Tri : plus r√©cent en haut
        const list = Object.keys(data).map(k => ({...data[k]})).sort((a,b) => b.date - a.date);

        list.forEach(item => {
          const d = new Date(item.date);
          const dateStr = d.toLocaleDateString('fr-FR', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' });
          // Nettoyage HTML pour snippet
          const cleanBody = (item.body || '').replace(/<[^>]+>/g, ' ').substring(0, 180) + '...';

          // Routage (si dispo)
          const routing = item.routing || null;
          const teamsLabel = routing?.teamNames?.length ? routing.teamNames.join(' ¬∑ ') : (routing?.teams?.length ? routing.teams.join(' ¬∑ ') : '‚Äî');
          const modeLabel = routing?.mode ? routing.mode : '‚Äî';
          const pushCount = routing?.recipients?.push ?? null;
          const emailCount = routing?.recipients?.email ?? null;
          const showRouting = !!routing;

          const card = document.createElement('div');
          card.className = 'alert-card';
          card.innerHTML = `
            <div class="alert-header">
               <span class="alert-badge">${item.source || 'ALERTE'}</span>
               <span class="alert-date">${dateStr}</span>
            </div>
            <div class="alert-title">${item.title}</div>
            ${showRouting ? `
              <div class="alert-routing" style="margin:8px 0 6px; display:flex; flex-wrap:wrap; gap:8px 10px;">
                <span class="alert-routing-chip">üéØ ${teamsLabel}</span>
                <span class="alert-routing-chip">‚öôÔ∏è ${modeLabel}</span>
                ${(pushCount !== null) ? `<span class="alert-routing-chip">üîî ${pushCount}</span>` : ''}
                ${(emailCount !== null) ? `<span class="alert-routing-chip">üìß ${emailCount}</span>` : ''}
              </div>
            ` : ''}
            <div class="alert-snippet">${cleanBody}</div>
          `;
          container.appendChild(card);
        });
      });
    }

    // --- COPIE DES SCRIPTS EMAIL.JS / APP.JS POUR LA PAGE ---
    // (Le reste du JS g√®re l'auth et la partie Diffusion via email.js inclus plus haut)
    
    // Auth Check & Theme
    if(localStorage.getItem('heiko:darkmode') === 'true') document.body.classList.add('dark-mode');
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('heiko:darkmode', document.body.classList.contains('dark-mode'));
      const icon = document.querySelector('.toggle-icon'); if(icon) icon.textContent = document.body.classList.contains('dark-mode') ? 'üåô' : '‚òÄÔ∏è';
    }

    firebase.auth().onAuthStateChanged(user => {
      if(user) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        
        firebase.database().ref('users/' + user.uid).once('value', snap => {
          const u = snap.val();
          if(u) {
            window.currentUser = u;
            window.currentUser.uid = user.uid;
            
            document.getElementById('userName').textContent = u.name || 'Membre';
            document.getElementById('userHours').textContent = (u.hours || 35) + 'h';
            
            const isAdmin = (u.role === 'admin' || u.role === 'superadmin');
            
            // Gestion visibilit√© onglet Diffusion
            if(isAdmin) {
              document.getElementById('adminOnlyContent').style.display = 'block';
              document.getElementById('nonAdminMessage').style.display = 'none';
              document.getElementById('btnAdmin').style.display = 'inline-block';
              
              // Chargement donn√©es mail
              firebase.database().ref('mailGroups').on('value', s => { window.mailGroups = s.val() || {}; renderDiffusionUI(); });
              firebase.database().ref('users').on('value', s => { window.allUsers = s.val() || {}; renderDiffusionUI(); });
              firebase.database().ref('settings').on('value', s => { window.globalSettings = s.val() || {}; renderDiffusionUI(); });

            } else {
              document.getElementById('adminOnlyContent').style.display = 'none';
              document.getElementById('nonAdminMessage').style.display = 'block';
            }
          }
        });
      } else {
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('appContent').style.display = 'none';
      }
    });

    document.getElementById('btnLogin').onclick = function() {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      firebase.auth().signInWithEmailAndPassword(email, pass).catch(() => alert('Erreur mot de passe'));
    };

    function logout() { firebase.auth().signOut(); location.reload(); }
    function clearLoginError() {} 
    function togglePass() { const x = document.getElementById('loginPass'); x.type = x.type==='password'?'text':'password'; }
    function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.className='show'; setTimeout(()=>t.className='hide',3000); }
    window.showToast = showToast;

    // Bridge vers email.js
    function renderDiffusionUI() {
      if(typeof window.renderQuickGroups === 'function') window.renderQuickGroups();
      if(typeof window.renderUsersGrid === 'function') window.renderUsersGrid();
      if(typeof window.renderGroupsList === 'function') window.renderGroupsList();
      if(typeof window.renderAlertRoutingUI === 'function') window.renderAlertRoutingUI();
      if(typeof window.renderAlertTeamsList === 'function') window.renderAlertTeamsList();
      
      const reg = document.getElementById('mailFunctionsRegion');
      const fromName = document.getElementById('mailFromName');
      if(reg && window.globalSettings?.functionsRegion) reg.value = window.globalSettings.functionsRegion;
      if(fromName && window.globalSettings?.mailFromName) fromName.value = window.globalSettings.mailFromName;
    }
    
    // Menu mobile
    function toggleGlobalMenu(force) {
      const menu = document.getElementById('globalMenu');
      const backdrop = document.getElementById('globalMenuBackdrop');
      const isOpen = menu.classList.contains('open');
      const shouldOpen = typeof force === 'boolean' ? force : !isOpen;
      if(shouldOpen) { menu.classList.add('open'); backdrop.classList.add('open'); }
      else { menu.classList.remove('open'); backdrop.classList.remove('open'); }
    }
  </script>
</body>
</html>
